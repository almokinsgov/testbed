<!DOCTYPE html>
<html lang="en-NZ">
<head>
  <meta charset="UTF-8">
  <title>Far North Disaster And Emergency Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b5296">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon-180.png">
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <style>
    :root {
      --bg-page: #eceff1;
      --bg-main: #f7f7f7;
      --bg-header: #0b5296;
      --bg-hero: #0b5296;
      --bg-panel: #ffffff;
      --text-main: #111827;
      --text-muted: #4b5563;
      --accent-red: #d84343;
      --accent-blue: #1976d2;
      --accent-teal: #00897b;
      --accent-grey: #455a64;
      --shadow-soft: 0 3px 10px rgba(0, 0, 0, 0.18);
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .skip-link {
      position: absolute;
      left: -999px;
      top: 0.75rem;
      z-index: 1000;
      padding: 0.6rem 1rem;
      background: #000000;
      color: #ffffff;
      font-size: 0.9rem;
      border-radius: var(--radius-pill);
      text-decoration: none;
    }

    .skip-link:focus {
      left: 1rem;
      outline: 3px solid #ffc107;
      outline-offset: 2px;
    }

    /* Header */

    .site-header {
      background: var(--bg-header);
      color: #ffffff;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.7rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      background: linear-gradient(135deg, #ffb300, #ff7043);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      color: #111827;
      box-shadow: var(--shadow-soft);
    }

    .brand-text h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .brand-text p {
      margin: 0.1rem 0 0;
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .header-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.82rem;
    }

    .header-right span {
      opacity: 0.9;
    }

    /* Hero */

    .hero {
      background: url("https://images.pexels.com/photos/240040/pexels-photo-240040.jpeg?auto=compress&cs=tinysrgb&w=1600") center/cover no-repeat; 
	  background-color: #0b5296;
      position: relative;
       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.35);
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to right, rgba(7, 26, 48, 0.88), rgba(7, 26, 48, 0.35));
    }

    .hero-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.2rem 1.25rem 1.4rem;
      position: relative;
      color: #ffffff;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
    }

    .hero-text h2 {
      margin: 0 0 0.3rem;
      font-size: 1.5rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .hero-text p {
      margin: 0;
      font-size: 0.95rem;
      max-width: 480px;
    }

    .hero-status {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .hero-pill {
      padding: 0.3rem 0.8rem;
      border-radius: var(--radius-pill);
      background: #ffd54f;
      color: #4e342e;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .hero-emergency {
      font-weight: 600;
    }

    /* Main */

    .page-main {
      background: var(--bg-main);
      box-shadow: 0 -3px 8px rgba(0, 0, 0, 0.15);
    }

    .main-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 2.5rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    /* Top action buttons */

    .cta-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.8rem;
    }

    .cta-btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      padding: 0.9rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      text-decoration: none;
      color: #ffffff;
      background: var(--accent-red);
      box-shadow: var(--shadow-soft);
    }

    .cta-btn.secondary {
      background: var(--accent-grey);
    }

    .cta-btn span.icon {
      font-size: 1.1rem;
    }

    .cta-btn:focus-visible {
      outline: 3px solid #ffeb3b;
      outline-offset: 2px;
    }

    /* Situation overview */

    .situation-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr);
      gap: 1rem;
    }

    .map-panel,
    .alert-panel {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem;
    }

    .map-panel-header,
    .alert-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.35rem 0.6rem;
      margin-bottom: 0.6rem;
    }

    .map-panel-header h3,
    .alert-panel-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .map-panel-header span,
    .alert-panel-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .map-placeholder {
      border-radius: var(--radius-md);
      background: #e0e7ef;
      min-height: 260px;
      height: min(56vh, 360px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4b5563;
      font-size: 0.9rem;
      border: 1px solid #cfd8dc;
    }

    .alert-body {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .alert-body strong {
      color: var(--text-main);
    }

    .alert-list {
      list-style: none;
      padding: 0;
      margin: 0.6rem 0 0;
      font-size: 0.85rem;
    }

    .alert-list li {
      padding: 0.4rem 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .alert-list li:last-child {
      border-bottom: none;
    }

    .alert-label {
      font-weight: 600;
      margin-right: 0.25rem;
    }

    .alert-tag {
      display: inline-block;
      margin-left: 0.25rem;
      padding: 0.1rem 0.45rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      background: #ffe082;
      color: #6d4c41;
    }

    /* Alert summary panel */

    .summary-panel {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem 1rem;
      font-size: 0.9rem;
    }

    .summary-panel h3 {
      margin: 0 0 0.25rem;
      font-size: 1rem;
    }

    .summary-collapse-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0.25rem 0 0.55rem;
      padding: 0.3rem 0.65rem;
      border: 1px solid #b8c6da;
      border-radius: 999px;
      background: #f5f9ff;
      color: #0f2f55;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
    }

    .summary-collapse-toggle:hover {
      background: #eaf3ff;
      border-color: #8fb2dd;
    }

    .summary-collapse-toggle:focus-visible {
      outline: 3px solid #ffeb3b;
      outline-offset: 2px;
    }

    .summary-panel p {
      margin: 0.1rem 0;
      color: var(--text-muted);
    }
	
	.summary-banner {
  margin-top: 0.75rem;
  font-size: 0.875rem;
}

.summary-banner-heading {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  margin-bottom: 0.25rem;
}

.summary-banner-body p {
  margin: 0.15rem 0;
}


    /* Stats and counters */

    .stats-section {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 1.1rem 1.05rem 1.2rem;
      border: 1px solid #dbe6f3;
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin: 0 0 0.6rem;
      padding: 0 0.2rem;
    }

    .stats-header h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      line-height: 1.25;
    }

    .stats-header span {
      font-size: 0.86rem;
      color: #425466;
      font-weight: 500;
      line-height: 1.35;
    }

    .stats-helper {
      margin: 0 0.45rem 0.65rem;
      font-size: 0.82rem;
      line-height: 1.4;
      color: #35516d;
      background: #eef6ff;
      border: 1px solid #d3e6fb;
      border-radius: 0.6rem;
      padding: 0.38rem 0.55rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.9rem;
    }

    .stat-card {
  display: grid;
  grid-template-columns: minmax(3rem, auto) 1fr;
  gap: 0.7rem;
  align-items: start;
  padding: 0.95rem 0.95rem;
  border-radius: var(--radius-md);
  background: #ffffff;
  text-decoration: none;
  color: var(--text-main);
  box-shadow: 0 1px 2px rgba(16, 24, 40, 0.06);
  border-left: 4px solid var(--accent-blue);
  border: 1px solid #dbe6f3;
  cursor: pointer;        /* makes button and link feel the same */
  transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
  min-height: 7.2rem;
}

.stat-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
  border-color: #9cc5f2;
}


    .stat-card.red {
      border-left-color: var(--accent-red);
    }

    .stat-card.teal {
      border-left-color: var(--accent-teal);
    }

    .stat-card.grey {
      border-left-color: var(--accent-grey);
    }

    .stat-card:focus-visible {
      outline: 3px solid #ffeb3b;
      outline-offset: 2px;
    }

    .stat-number {
      font-size: 1.66rem;
      font-weight: 700;
      line-height: 1;
      min-width: 2.9rem;
      text-align: center;
      color: #0f2f50;
      background: #eef6ff;
      border-radius: 0.7rem;
      padding: 0.45rem 0.35rem;
      border: 1px solid #c9def7;
      font-variant-numeric: tabular-nums;
    }

    .stat-info {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.92rem;
      min-height: 100%;
    }

    .stat-title {
      font-weight: 700;
      margin: 0.22rem 0 0;
      color: #0f2f50;
      font-size: 1.02rem;
      line-height: 1.25;
      text-align: left;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stat-kind {
      display: inline-block;
      margin: 0;
      font-size: 0.72rem;
      line-height: 1;
      padding: 0.18rem 0.42rem;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-transform: none;
      background: #edf2f7;
      color: #27435f;
      border: 1px solid #d5e1ec;
    }

    .stat-kind.roads {
      background: #eaf7ef;
      color: #1f5d3c;
      border-color: #c5e8d1;
    }

    .stat-kind.utilities {
      background: #fff6e8;
      color: #8a5b1f;
      border-color: #f7ddb2;
    }

    .stat-kind.alerts {
      background: #fef2f2;
      color: #8f3030;
      border-color: #f3caca;
    }

    .stat-desc {
      margin: 0;
      color: #425466;
      font-size: 0.83rem;
      line-height: 1.35;
      text-align: left;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .stat-badge {
      display: inline-block;
      padding: 0.16rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0;
      text-transform: none;
      background: #e5e7eb;
      color: #374151;
    }

    .stat-badge.normal {
      background: #dcfce7;
      color: #166534;
    }

    .stat-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .stat-badge.critical {
      background: #fee2e2;
      color: #991b1b;
    }

    .stat-meta {
      margin-top: auto;
      font-size: 0.78rem;
      line-height: 1.25;
      color: #3c4f63;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.42rem;
      padding-top: 0.32rem;
      border-top: 1px dashed #dbe6f3;
    }

    .stat-pill-row {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.32rem;
    }

    .stat-meta .stat-action {
      font-weight: 600;
      color: #0f2f50;
      background: #eef6ff;
      border: 1px solid #d3e6fb;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      margin-left: auto;
    }

    .stat-conn-pill {
      display: inline-block;
      font-size: 0.72rem;
      font-weight: 600;
      line-height: 1;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.18rem 0.42rem;
    }

    .stat-conn-pill.ok {
      color: #0f766e;
      background: #e6fffb;
      border-color: #bdeee4;
    }

    .stat-conn-pill.loading {
      color: #92400e;
      background: #fff7e6;
      border-color: #f7ddb2;
    }

    .stat-conn-pill.failed {
      color: #b91c1c;
      background: #fef2f2;
      border-color: #f3caca;
    }

    .stat-conn-pill.disabled {
      color: #6b7280;
      background: #f3f4f6;
      border-color: #d1d5db;
    }
	
	/* Stats modal */

.stats-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.stats-modal-backdrop.is-visible {
  display: flex;
}

.stats-modal {
  background: #ffffff;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
  max-width: 80vw;
  width: 96%;
  max-height: 80vh;
  padding: 1rem 1.1rem;
  overflow: auto;
}

.stats-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 0.6rem;
  position: sticky;
  top: 0;
  background: #ffffff;
  z-index: 2;
  padding-bottom: 0.35rem;
  border-bottom: 1px solid #e5e7eb;
}

.stats-modal-header h3 {
  margin: 0;
  font-size: 1rem;
}

.stats-modal-close {
  border: none;
  background: transparent;
  font-size: 1.25rem;
  cursor: pointer;
}

.stats-modal-body {
  font-size: 0.9rem;
  color: #1f2937;
  overflow-x: auto;
}

.stats-modal-body .stats-modal-table {
  display: table;
  width: 100%;
  table-layout: auto;
}

.stats-modal-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.86rem;
  margin-bottom: 0.8rem;
  min-width: 860px;
}

.stats-modal-table th,
.stats-modal-table td {
  padding: 0.52rem 0.62rem;
  text-align: left;
  border-bottom: 1px solid #e6edf5;
  vertical-align: top;
  line-height: 1.35;
}

.stats-modal-table th {
  font-weight: 600;
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: #334155;
  background: #f3f7fb;
  position: sticky;
  top: 0;
  z-index: 1;
}

.stats-modal-table tbody tr:nth-child(even) {
  background: #fafcff;
}

.stats-modal-table tbody tr:hover {
  background: #eef6ff;
}

.stats-modal-source {
  margin: 0.35rem 0 0;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.stats-modal-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin: 0 0 0.65rem 0;
}

.stats-modal-summary span {
  display: inline-flex;
  align-items: center;
  padding: 0.18rem 0.5rem;
  border-radius: 999px;
  border: 1px solid #d6e3f2;
  background: #f8fbff;
  color: #1e3a5f;
  font-size: 0.76rem;
  font-weight: 600;
}

.stats-modal-no-data {
  padding: 0.4rem 0.2rem;
  color: #475569;
}

.stats-table-pill {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 0.1rem 0.45rem;
  font-size: 0.74rem;
  font-weight: 700;
  border: 1px solid transparent;
  white-space: nowrap;
}

.stats-table-pill.neutral { background: #eef2f7; border-color: #d5dee8; color: #334155; }
.stats-table-pill.info { background: #e9f3ff; border-color: #bfd8fa; color: #1e40af; }
.stats-table-pill.warning { background: #fff4e8; border-color: #f6d3aa; color: #9a3412; }
.stats-table-pill.success { background: #ebfaef; border-color: #b8e6c2; color: #166534; }
.stats-table-pill.danger { background: #ffedf0; border-color: #f6bcc8; color: #9f1239; }

.stats-cell-details {
  max-width: 360px;
  white-space: normal;
  word-break: break-word;
}

@media (max-width: 760px) {
  .stats-modal-body {
    overflow-x: visible;
  }

  .stats-modal-table {
    min-width: 0;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .stats-modal-table thead {
    display: none;
  }

  .stats-modal-table tbody,
  .stats-modal-table tr,
  .stats-modal-table td {
    display: block;
    width: 100%;
  }

  .stats-modal-table tbody tr {
    border: 1px solid #d8e4f0;
    border-radius: 10px;
    background: #ffffff;
    margin: 0 0 0.7rem 0;
    padding: 0.2rem 0;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
  }

  .stats-modal-table tbody tr:nth-child(even),
  .stats-modal-table tbody tr:hover {
    background: #ffffff;
  }

  .stats-modal-table td {
    border-bottom: 1px solid #edf2f7;
    padding: 0.45rem 0.68rem;
  }

  .stats-modal-table td:last-child {
    border-bottom: none;
  }

  .stats-modal-table td::before {
    content: attr(data-label);
    display: block;
    margin-bottom: 0.14rem;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: #475569;
  }

  .stats-modal-table td.stats-modal-no-data::before {
    content: none;
  }
}


    /* Tiles row */

    .tiles-section {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem 0.9rem 1rem;
    }

    .tiles-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin: 0 0 0.7rem;
      padding: 0 0.2rem;
    }

    .tiles-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .tiles-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tile-group {
      margin-bottom: 1.1rem;
    }

    .tile-group:last-of-type {
      margin-bottom: 0.4rem;
    }

    .tile-group-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin: 0 0 0.4rem;
      padding: 0 0.2rem;
    }

    .tile-group-header h4 {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .tile-group-header span {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .tile-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.8rem;
    }

    .tile {
      border-radius: var(--radius-md);
      padding: 0.9rem 0.9rem;
      color: #ffffff;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--shadow-soft);
    }

    .tile .icon {
      font-size: 1.4rem;
    }

    .tile-main {
      font-size: 0.9rem;
    }

    .tile-main h4 {
      margin: 0 0 0.2rem;
      font-size: 0.98rem;
    }

    .tile-main p {
      margin: 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .tile-meta {
      text-align: right;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .tile-meta strong {
      display: block;
      font-size: 1.15rem;
    }

    .tile.red {
      background: var(--accent-red);
    }

    .tile.blue {
      background: var(--accent-blue);
    }

    .tile.teal {
      background: var(--accent-teal);
    }

    .tile.grey {
      background: var(--accent-grey);
    }

    .tile:focus-visible {
      outline: 3px solid #ffeb3b;
      outline-offset: 2px;
    }

    /* Secondary links bar */

    .link-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }

    .link-chip {
      flex: 1 1 150px;
      text-align: center;
      padding: 0.45rem 0.5rem;
      border-radius: var(--radius-md);
      background: #263238;
      color: #eceff1;
      font-size: 0.8rem;
      text-decoration: none;
    }

    .link-chip:focus-visible {
      outline: 3px solid #ffeb3b;
      outline-offset: 2px;
    }

    /* Footer */

    .site-footer {
      background: #1c1c1c;
      color: #e0e0e0;
      font-size: 0.78rem;
      padding: 0.7rem 1.2rem;
      text-align: center;
    }

    .site-footer span + span {
      margin-left: 0.2rem;
    }

    .site-footer a {
      color: #ffeb3b;
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }

    @media (min-width: 720px) {
      .cta-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .tile-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (min-width: 1160px) {
      .stats-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (min-width: 1500px) {
      .stats-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (min-width: 960px) {
      .situation-row {
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      }

      .map-placeholder {
        height: 450px;
      }
    }

    @media (max-width: 768px) {
      .tile-grid {
        grid-template-columns: repeat(var(--tile-mobile-columns, 2), minmax(0, 1fr));
      }

      .header-inner {
        padding-left: 0.7rem;
        padding-right: 0.7rem;
      }

      .hero-inner {
        padding-left: 0.7rem;
        padding-right: 0.7rem;
      }

      .main-inner {
        max-width: 100%;
        padding: 1rem 0.65rem 1.8rem;
        gap: 1rem;
      }

      .map-panel,
      .alert-panel,
      .summary-panel,
      .stats-section,
      .tiles-section,
      .social-section {
        margin-left: 0;
        margin-right: 0;
      }
    }

    @media (max-width: 480px) {
      .header-inner {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .hero-inner {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .main-inner {
        padding: 0.85rem 0.45rem 1.4rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        scroll-behavior: auto !important;
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
	
	/* Situation map legend */
.map-legend {
      background: rgba(255, 255, 255, 0.95);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
      font-size: 0.85rem;
      line-height: 1.4;
      max-height: 56vh;
      overflow-y: auto;
    }

    .map-legend.map-legend-below {
      margin-top: 0.45rem;
      border-radius: 8px;
      max-height: none;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.18);
      width: 100%;
    }

    .map-legend.map-legend-below .legend-content {
      max-height: none;
    }

    .map-legend.map-legend-below ul {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.35rem 0.9rem;
      align-items: start;
    }

    .map-legend.map-legend-below ul > li > strong {
      display: block;
      margin-top: 0.2rem;
      margin-bottom: 0.1rem;
      padding-bottom: 0.15rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .map-legend h2 {
      font-size: 0.9rem;
      margin: 0 0 0.25rem;
    }

    .map-legend ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .map-legend li {
      margin: 0.1rem 0;
    }

    .layer-pill {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e0e0e0;
      margin-right: 0.25rem;
    }
	
	    .legend-item {
      display: flex;
      align-items: center;
      margin: 0.15rem 0;
    }

    .legend-swatch {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.4rem;
      border: 2px solid #ffffff;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }

    .legend-swatch-symbol {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.45);
    }
/* Ensure the situation map fills the map panel */
#situation-map {
  width: 100%;
  height: 100%;
}
.legend-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.25rem;
  width: 100%;
  font-size: 0.85rem;
  font-weight: 600;
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
}

.legend-title {
  flex: 1;
  text-align: left;
}

.legend-toggle-icon {
  font-size: 0.75rem;
  transition: transform 0.15s ease-in-out;
}

.map-legend.legend-collapsed .legend-toggle-icon {
  transform: rotate(-90deg);
}

.legend-content {
  margin-top: 0.35rem;
}

	/* Hide standalone RWAS popup and toggle now that alerts live in the panel */
#floating-alerts-container,
#toggle-alerts-btn {
  display: none !important;
}

/* Let RWAS cards sit nicely inside the dashboard list */
.alert-list .alert-item {
  padding: 0;
  border-bottom: none;
  margin-bottom: 0.6rem;
}

.alert-list .alert-item:last-child {
  margin-bottom: 0;
}

.alert-list-meta {
  padding-top: 0.3rem;
  border-bottom: none;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.feed-health {
  margin-top: 0.75rem;
  padding-top: 0.5rem;
  border-top: 1px solid #dbe3e8;
}

.feed-health-heading {
  margin: 0 0 0.3rem 0;
  font-size: 0.78rem;
  color: var(--text-muted);
}

.feed-health-list {
  margin: 0;
  padding: 0;
  list-style: none;
}

.feed-health-list li {
  margin: 0;
  padding: 0.2rem 0;
  font-size: 0.75rem;
  color: var(--text-muted);
}

  
  /* Editor UI */
  .edit-toggle {
    margin-left: 0.6rem;
    padding: 0.35rem 0.7rem;
    font-size: 0.85rem;
    border-radius: 999px;
    border: 1px solid #cfd8dc;
    background: #ffffff;
    cursor: pointer;
    white-space: nowrap;
  }

  .edit-toggle:focus-visible {
    outline: 3px solid #ffeb3b;
    outline-offset: 2px;
  }

  body.edit-mode .edit-toggle {
    background: #0b5296;
    color: #ffffff;
    border-color: #0b5296;
  }

  body.edit-mode {
    overflow: hidden;
  }

  body.edit-mode.editor-capture-mode {
    overflow: auto;
  }

  .editor-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.42);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 1.25rem;
  }

  body.edit-mode .editor-backdrop {
    display: flex;
  }

  .editor-drawer {
    width: min(1880px, 99vw);
    height: min(96vh, 1300px);
    border-radius: 16px;
    background: #ffffff;
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    isolation: isolate;
  }

  body.edit-mode.editor-capture-mode .editor-backdrop {
    position: absolute;
    inset: 0;
    align-items: flex-start;
    padding-top: 0.8rem;
    padding-bottom: 0.8rem;
  }

  body.edit-mode.editor-capture-mode .editor-drawer {
    height: auto;
    max-height: none;
    overflow: visible;
  }

  .editor-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #eceff1;
    position: sticky;
    top: 0;
    z-index: 4;
    background: #ffffff;
  }

  .editor-header h3 {
    margin: 0;
    font-size: 1.25rem;
  }

  .editor-close {
    background: transparent;
    border: 0;
    font-size: 1.6rem;
    line-height: 1;
    cursor: pointer;
    padding: 0.15rem 0.35rem;
  }

  .editor-body {
    display: grid;
    grid-template-columns: minmax(300px, 0.75fr) minmax(980px, 2.7fr);
    gap: 1.35rem;
    padding: 1.45rem;
    overflow: hidden;
    flex: 1;
  }

  body.edit-mode.editor-capture-mode .editor-body {
    overflow: visible;
  }

  .editor-left {
    border: 1px solid #eceff1;
    border-radius: 12px;
    padding: 1rem;
    overflow: auto;
    min-width: 0;
  }

  body.edit-mode.editor-capture-mode .editor-left {
    overflow: visible;
  }

  .editor-right {
    border: 1px solid #eceff1;
    border-radius: 12px;
    padding: 1.45rem;
    overflow: auto;
    min-width: 0;
    background: #fcfdff;
  }

  body.edit-mode.editor-capture-mode .editor-right {
    overflow: visible;
  }

  #editor-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap: 1.1rem 1.3rem;
    align-items: start;
  }

  #editor-panel > h3,
  #editor-panel > h4,
  #editor-panel > .editor-inline,
  #editor-panel > .editor-note,
  #editor-panel > .editor-array-block,
  #editor-panel > .editor-section-block {
    grid-column: 1 / -1;
  }

  #editor-panel > h3 {
    margin: 0;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid #dfe7ee;
    font-size: 1.3rem;
    position: sticky;
    top: 0;
    background: #fcfdff;
    z-index: 2;
  }

  #editor-panel > h4 {
    margin: 0.75rem 0 0.25rem 0;
    font-size: 1.02rem;
    color: #2c4958;
  }

  .editor-section-title {
    font-weight: 700;
    margin-bottom: 0.6rem;
  }

  .editor-toolbar {
    display: flex;
    gap: 0.45rem;
    flex-wrap: wrap;
    margin-bottom: 0.6rem;
  }

  .editor-quick-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.6rem;
  }

  .editor-quick-btn {
    border: 1px solid #cfd8dc;
    border-radius: 999px;
    background: #f8fafb;
    color: #334e5a;
    padding: 0.3rem 0.65rem;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .editor-quick-btn.is-active {
    background: #e8f0fe;
    border-color: #90caf9;
    color: #0b5296;
  }

  .editor-quick-btn.editor-quick-btn-sub {
    border-style: dashed;
    font-size: 0.82rem;
    color: #2f5f78;
  }

  .editor-subpage-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
    margin: 0.1rem 0 0.2rem 0;
    padding: 0.25rem;
    border: 1px solid #d8e2ea;
    border-radius: 12px;
    background: #f7fafd;
  }

  .editor-subpage-btn {
    border: 1px solid #c7d4df;
    border-radius: 999px;
    background: #ffffff;
    color: #244a63;
    padding: 0.38rem 0.82rem;
    font-size: 0.9rem;
    cursor: pointer;
  }

  .editor-subpage-btn.is-active {
    background: #e8f0fe;
    border-color: #8eb8de;
    color: #0b5296;
    font-weight: 700;
  }

  .editor-module-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.6rem 0.65rem;
    border-radius: 10px;
    cursor: pointer;
  }

  .editor-module-item:hover {
    background: #f5f7f8;
  }

  .editor-module-item.is-active {
    background: #e8f0fe;
  }

  .editor-submodule-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-left: 1rem;
    padding: 0.48rem 0.65rem;
    border-radius: 9px;
    cursor: pointer;
    border-left: 2px solid #d6e2ec;
  }

  .editor-submodule-item:hover {
    background: #f4f9fd;
  }

  .editor-submodule-item.is-active {
    background: #e9f3fe;
    border-left-color: #90caf9;
  }

  .editor-chip {
    font-size: 0.8rem;
    padding: 0.16rem 0.52rem;
    border-radius: 999px;
    border: 1px solid #cfd8dc;
    background: #ffffff;
    color: #455a64;
  }

  .editor-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.8rem;
    position: sticky;
    top: 0;
    z-index: 3;
    background: #ffffff;
    padding: 0.55rem 0;
    border-bottom: 1px solid #eceff1;
  }

  .editor-btn {
    padding: 0.55rem 0.9rem;
    border-radius: 10px;
    border: 1px solid #cfd8dc;
    background: #ffffff;
    cursor: pointer;
    font-size: 0.92rem;
  }

  .editor-btn.primary {
    background: #0b5296;
    color: #ffffff;
    border-color: #0b5296;
  }

  .editor-btn.danger {
    background: #b71c1c;
    color: #ffffff;
    border-color: #b71c1c;
  }

  .editor-note {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    color: #607d8b;
  }

  .editor-action-status {
    display: flex;
    gap: 0.45rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .editor-status-chip {
    font-size: 0.74rem;
    padding: 0.18rem 0.45rem;
    border-radius: 999px;
    border: 1px solid #cfd8dc;
    background: #f8fafb;
    color: #455a64;
  }

  .editor-status-chip.dirty {
    border-color: #ff9800;
    color: #7a4a00;
    background: #fff3e0;
  }

  .editor-status-chip.hidden {
    display: none;
  }

  .editor-field {
    margin-bottom: 0.15rem;
    min-width: 0;
  }

  .editor-field.editor-field--wide {
    grid-column: 1 / -1;
  }

  .editor-field label {
    display: block;
    font-size: 0.94rem;
    color: #455a64;
    margin-bottom: 0.28rem;
  }

  .editor-field-label-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.2rem;
  }

  .editor-field-reset {
    border: 1px solid #cfd8dc;
    background: #f8fafb;
    color: #455a64;
    border-radius: 8px;
    font-size: 0.72rem;
    padding: 0.15rem 0.45rem;
    cursor: pointer;
  }

  .editor-field-reset.hidden {
    display: none;
  }

  .editor-field-error {
    font-size: 0.74rem;
    color: #b71c1c;
    margin-top: 0.22rem;
  }

  .editor-field input,
  .editor-field textarea,
  .editor-field select {
    width: 100%;
    border: 1px solid #cfd8dc;
    border-radius: 10px;
    padding: 0.68rem 0.75rem;
    font-size: 1.02rem;
    line-height: 1.35;
  }

  .editor-field textarea {
    min-height: 190px;
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .editor-array-block {
    border: 1px solid #e5ebf0;
    border-radius: 12px;
    padding: 0.85rem;
    background: #ffffff;
  }

  .editor-section-block {
    border: 1px solid #dbe6ef;
    border-radius: 12px;
    padding: 0.8rem 0.85rem;
    background: #fafdff;
  }

  .editor-section-block > h4 {
    margin-top: 0;
  }

  .editor-section-block .editor-note {
    margin-top: 0;
    margin-bottom: 0.5rem;
  }

  #editor-panel.editor-panel-alerts-page .editor-section-block {
    display: grid;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap: 0.5rem 0.85rem;
    align-items: start;
  }

  #editor-panel.editor-panel-alerts-page .editor-section-block > h4,
  #editor-panel.editor-panel-alerts-page .editor-section-block > .editor-note,
  #editor-panel.editor-panel-alerts-page .editor-section-block > .editor-inline {
    grid-column: 1 / -1;
  }

  #editor-panel.editor-panel-alerts-page .editor-section-block .editor-field.editor-field--wide {
    grid-column: 1 / -1;
  }

  #editor-panel.editor-panel-stats-runtime .editor-section-block {
    display: grid;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap: 0.5rem 0.85rem;
    align-items: start;
  }

  #editor-panel.editor-panel-stats-runtime .editor-section-block > h4,
  #editor-panel.editor-panel-stats-runtime .editor-section-block > .editor-note,
  #editor-panel.editor-panel-stats-runtime .editor-section-block > .editor-inline,
  #editor-panel.editor-panel-stats-runtime .editor-section-block > h5 {
    grid-column: 1 / -1;
  }

  #editor-panel.editor-panel-stats-runtime .editor-array-block {
    grid-column: 1 / -1;
  }

  .editor-array-block > h4 {
    margin: 0 0 0.55rem 0;
  }

  .editor-array-item {
    border: 1px solid #dbe5ec;
    border-radius: 10px;
    margin-bottom: 0.7rem;
    background: #fbfdff;
    overflow: hidden;
  }

  .editor-array-summary {
    cursor: pointer;
    list-style: none;
    padding: 0.7rem 0.82rem;
    display: flex;
    gap: 0.55rem;
    align-items: center;
    border-bottom: 1px solid #e7edf3;
    background: #f3f8fc;
  }

  .editor-array-summary::-webkit-details-marker {
    display: none;
  }

  .editor-array-summary::before {
    content: "\25B8";
    color: #466170;
    font-size: 0.85rem;
  }

  .editor-array-item[open] .editor-array-summary::before {
    content: "\25BE";
  }

  .editor-array-body {
    padding: 0.82rem 0.85rem 0.95rem 0.85rem;
  }

  .editor-array-controls {
    margin-bottom: 0.6rem;
  }

  .editor-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .editor-inline .editor-btn {
    padding: 0.45rem 0.65rem;
    font-size: 0.86rem;
  }

  @media (max-width: 1200px) {
    .editor-drawer {
      width: min(1560px, 99vw);
      height: 94vh;
    }

    .editor-body {
      grid-template-columns: minmax(280px, 330px) minmax(0, 1fr);
      gap: 1.05rem;
      padding: 1.05rem;
    }

    #editor-panel.editor-panel-alerts-page .editor-section-block {
      grid-template-columns: 1fr;
    }

    #editor-panel.editor-panel-stats-runtime .editor-section-block {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 960px) {
    .editor-backdrop {
      padding: 0.65rem;
    }

    .editor-drawer {
      width: 100vw;
      height: 96vh;
      border-radius: 12px;
    }

    .editor-body {
      grid-template-columns: 1fr;
      gap: 0.85rem;
    }

    .editor-left,
    .editor-right {
      max-height: 42vh;
    }

    #editor-panel {
      grid-template-columns: 1fr;
    }
  }

  body.edit-mode [data-module-id] {
    outline: 2px dashed rgba(11, 82, 150, 0.55);
    outline-offset: 6px;
  }

  body.edit-mode.editor-focus-mode [data-module-id].editor-focus-muted {
    opacity: 0.42;
    filter: saturate(0.7);
    transition: opacity 120ms ease;
  }

  body.edit-mode.editor-focus-mode [data-module-id].editor-focus-active {
    opacity: 1;
    outline: 3px solid rgba(11, 82, 150, 0.75);
    outline-offset: 4px;
  }

  body.edit-mode [data-submodule-id] {
    outline: 2px dashed rgba(255, 193, 7, 0.65);
    outline-offset: 6px;
  }

</style>
  <style>/* //Region warning and alerts - created by Amorangi Mathews 
 //version and current functionality 
  //1.2.1.7 to 1.3.2.0 single html file to JS,CSS and HTML, hosted in Github served with a CDN  */

    .alert-card {
      background: #fff0f0;
      border-left: 5px solid #ffa500;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
    }
    .far-north {
      border-left-color: #dc3545;
      /* background: #fff0f0; */
    }

    /* Floating alerts window and toggle icon */
    #floating-alerts-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 450px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      border: #8f8f8f;
    border-style: solid;
    border-width: thin;
      background: #FFFFFF;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      /*border-left: 4px solid #FFFFFF;*/
      border-radius: 8px;
      padding: 1rem;
          font-size: 13.8px;
    line-height: normal;
    }

    #toggle-alerts-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      background: #ffcc00;
          background: linear-gradient(to right, #ed0017, #ed0017);
    border-radius: 50%;
    /*border: black;
    border-style: solid;
      border-width: thin;*/
        border-style: solid;
  border-width: medium;
  border-color: #750000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      font-size: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
    }

    #toggle-alerts-btn:hover {
      background: #ffaa00;
      background: linear-gradient(to right, #ffeb00, #ed0017);
    }
    
    @media (max-width: 600px) {
  #floating-alerts-container {
    width: 90vw;
    right: 0.5rem;
    left: 0.5rem;
    bottom: 4rem;
    max-height: 60vh;
    border-left-width: 3px;
    font-size: 0.95em;
        font-size: 13.8px;
    line-height: normal;
  }}

/* first badge work*/

.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
}

.active-now {
 /*  border-left-color: #e53935 !important;
  background: #ffeaea;  */
}

.upcoming {
/*  border-left-color: #0288d1 !important;
  background: #e3f2fd; */
}

.active-badge {
  background: #e53935;
  color: white;
}

.upcoming-badge {
  background: #e53935;
  color: white;
}
/* Default fallback */
.alert-default {
  border-left-color: #ffa500;
  background: #fffaf0;
}

.alert-orange {
  border-left-color: #FF8918;
  background: #fff3e0;
}
 
.alert-red {
  border-left-color: #d32f2f;
  background: #fdecea;
}

.alert-cd {
  border-left-color: #d32f2f;
  background: #123c59;
      border: solid;
    border-width: thin;
    border-color: #fffc38;
}

    
    
.alert-yellow {
  border-left-color: #fbc02d;
  background: #fffde7;
}

.alert-green {
  border-left-color: #388e3c;
  background: #e8f5e9;
}

/* Badge styles */
.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
  font-weight: 600;
  color: white;
}

    .badge.alert-met {background: #172344;}   
.badge.alert-orange { background: #FF8918; border: solid; border-width: thin; border-color: #000000; }
.badge.alert-red { background: #d32f2f;  border: solid; border-width: thin;    border-color: #000000;}
.badge.alert-yellow { background: #fbc02d; color: black;  border: solid; border-width: thin; border-color: #000000;}
.badge.alert-cd {color: white; }
.badge.alert-green { background: #388e3c; }

.active-now {
  /* optional override styles */
}

.upcoming {
  /* optional override styles */
}

    .expired-badge {
  background: #464951;
  color: white;
       border: solid;
    border-width: thin;
    border-color: #000000;
}
    /*style for initial header and footer*/
.alert-header {
    background: #868687;
    margin-bottom: 1rem;
    color: #000000;
  border-radius: 10px;
    padding: 10px 10px 10px 10px;
  /*  font-size: 14.2px; 
    line-height: 1.4;*/
     
}
.alert-header hr {
  border: none;
  border-top: 1px solid #ddd;
  margin-top: 0.5rem;
}
    .alert-footer {
  margin-top: 1rem;
  /*font-size: 12.2px;*/
 background: #868687;
    margin-bottom: 1rem;
    color: #000000;
  border-radius: 10px;
    padding: 10px 1px 10px 10px;
  line-height: 1.4;
}
.alert-footer a {
  color: #004d99;
  text-decoration: underline;
}
.alert-footer hr {
  border: none;
  border-top: 1px solid #ddd;
  margin-top: 1rem;
  
}

/*style for modern header and footer*/
.alert-header {
  background: linear-gradient(to right, #dc3545, #dc3545);
  color: white;
  border-style: solid;
  border-width: medium;
  border-color: #750000;
  padding: 0.75rem 1rem;
  border-radius: 8px 8px 0 0;
  /*font-size: 1rem;
  font-weight: 600;*/
  line-height: 1.4;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.alert-header em {
  font-style: normal;
  font-weight: 400;
  opacity: 0.95;
}

.alert-footer {
  background: #f4f6f8;
  border-top: 1px solid #e0e0e0;
  padding: 0.75rem 1rem;
  border-radius: 0 0 8px 8px;
  /*font-size: 0.85rem;
  color: #555;*/
  text-align: left;
  margin-top: 1rem;
}

.alert-footer a {
  color: #dc3545;
  text-decoration: none;
  font-weight: 500;
}

.alert-footer a:hover {
  text-decoration: underline;
}

/*cancelled badge for cd alerts*/
.cancelled-badge {
  background: #616161;
  color: white;
   border: solid;
    border-width: thin;
    border-color: #000000;
}

.leaflet-left .leaflet-control {
    max-height: 100vh !important;
 }
</style>

<style>
  /* Social media feeds section */

  .social-section {
    background: var(--bg-panel);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-soft);
    padding: 0.9rem 0.9rem 1rem;
  }

  .social-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin: 0 0 0.6rem;
    padding: 0 0.2rem;
  }

  .social-header h3 {
    margin: 0;
    font-size: 1rem;
  }

  .social-header span {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .social-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin: 0 0 0.6rem;
    padding: 0 0.2rem;
  }

  .social-tab {
    padding: 0.35rem 0.8rem;
    font-size: 0.85rem;
    border-radius: var(--radius-pill);
    border: 1px solid #cfd8dc;
    background: #eceff1;
    cursor: pointer;
    white-space: nowrap;
  }

  .social-tab.is-active {
    background: #0b5296;
    color: #ffffff;
    border-color: #0b5296;
  }

  .social-tab:focus-visible {
    outline: 3px solid #ffeb3b;
    outline-offset: 2px;
  }

 .social-frame-container {
  border-radius: var(--radius-md);
  overflow: hidden;
  background: #ffffff;              /* was #000000 */
  border: 1px solid #cfd8dc;
  display: flex;                    /* centre child */
  justify-content: center;
  padding: 0.5rem;                  /* small white border around iframe */
}

.social-frame-container iframe {
  width: 100%;
  max-width: 600px;                 /* narrower centred feed */
  height: 600px;                    /* match Facebook plugin height */
  border: 0;
  background: #ffffff;
}


  .social-note {
    margin-top: 0.5rem;
    font-size: 0.78rem;
    color: var(--text-muted);
    padding: 0 0.2rem;
  }

  
  }
</style>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
  
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="site-header" role="banner" data-module-id="header">
    <div class="header-inner">
      <div class="brand-block">
        <div class="brand-logo" aria-hidden="true" id="brand-logo"></div>
        <div class="brand-text">
          <h1 id="brand-council"></h1>
          <p id="brand-dashboard"></p>
        </div>
      </div>
      <div class="header-right" aria-label="Contact and language">
        <span id="header-contact"></span>
        <span aria-hidden="true">|</span>
        <span id="header-emergency"></span>
        <button type="button" class="edit-toggle" id="edit-toggle-btn" aria-label="Edit dashboard layout and content">Edit</button>
      </div>
    </div>

    <div class="hero" role="img" aria-label="Far North coastline with town and sea under changing weather" data-module-id="hero">
      <div class="hero-inner">
        <div class="hero-text">
          <h2 id="hero-title"></h2>
          <p id="hero-description"></p>
        </div>
        <div class="hero-status" aria-label="Current dashboard status">
          <span class="hero-pill" id="hero-pill"></span>
          <span class="hero-emergency" id="hero-emergency-message"></span>
          <span id="hero-last-updated"></span>
        </div>
      </div>
    </div>
  </header>
<div id="floating-alerts-container"></div>
<button id="toggle-alerts-btn" title="Weather Alerts">&#9888;</button>
  <main id="main-content" class="page-main" role="main" aria-label="Far North emergency information">
    <div class="main-inner">
      <!-- CTA buttons -->
      <section class="cta-row" aria-label="Alert registration and key actions" id="cta-row" data-module-id="ctaRow"></section>

      <!-- Situation overview -->
      <section class="situation-row" aria-label="Situation overview map and current alerts" data-module-id="situation">
        <div class="map-panel" role="group" aria-labelledby="map-heading" data-submodule-id="mapPanel">
          <div class="map-panel-header">
            <h3 id="map-heading"></h3>
            <span id="map-subtitle"></span>
          </div>
          <div class="map-placeholder" id="map-placeholder"></div>
        </div>

        <aside class="alert-panel" role="complementary" aria-labelledby="alerts-heading" data-submodule-id="alertsPanel">
          <div class="alert-panel-header">
            <h3 id="alerts-heading"></h3>
            <span id="alerts-subtitle"></span>
          </div>
          <div class="alert-body">
            <p id="alerts-lead"></p>
            <ul class="alert-list" id="alert-list"></ul>
          </div>
        </aside>
      </section>

      <!-- District alert summary -->
      <section class="summary-panel" aria-label="District alert summary" data-module-id="summary">
        <h3 id="summary-title"></h3>
        <div id="summary-paragraphs"></div>
        <div id="summary-custom-blocks"></div>
      </section>

      <!-- Stats and counters -->
      <section class="stats-section" aria-label="Far North status counters" data-module-id="stats">
        <div class="stats-header">
          <h3 id="stats-title"></h3>
          <span id="stats-subtitle"></span>
        </div>
        <p class="stats-helper" id="stats-helper">Tap a card for full details.</p>
        <div class="stats-grid" id="stats-grid"></div>
      </section>
	  
	  

      <!-- Tiles with levels -->
      <section class="tiles-section" aria-label="Key emergency information tiles grouped by level" data-module-id="tiles">
        <div class="tiles-header">
          <h3 id="tiles-title"></h3>
          <span id="tiles-subtitle"></span>
        </div>

        <div id="tile-groups"></div>

        <div class="link-bar" aria-label="Additional quick links" id="quick-links"></div>
      </section>
	    <!-- Social media feeds -->
      <section class="social-section" aria-label="Social Media Updates" data-module-id="social">
        <div class="social-header">
          <h3 id="social-title"></h3>
          <span id="social-subtitle"></span>
        </div>

        <div
          class="social-tabs"
          id="social-tabs"
          role="tablist"
          aria-label="Social media channels"
        ></div>

        <div class="social-frame-container">
          <iframe
            id="social-iframe"
            title="Social media feed"
            loading="lazy"
            allowfullscreen
          ></iframe>
        </div>

        <p class="social-note" id="social-note"></p>
      </section>
    </div>
	
  </main>

  <footer class="site-footer" role="contentinfo" data-module-id="footer">
    <span id="footer-line-1"></span>
    <span id="footer-line-2"></span>
  </footer>
  
  <div
  id="stats-modal-backdrop"
  class="stats-modal-backdrop"
  aria-hidden="true"
>
  <div
    class="stats-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="stats-modal-title"
  >
    <header class="stats-modal-header">
      <h3 id="stats-modal-title">FNDC Alerts</h3>
      <button
        type="button"
        id="stats-modal-close"
        class="stats-modal-close"
        aria-label="Close"
      >
        &times;
      </button>
    </header>
    <div id="stats-modal-body" class="stats-modal-body">
      <!-- Table is injected here -->
    </div>
  </div>
</div>


  
  <div id="editor-backdrop" class="editor-backdrop" aria-hidden="true">
    <div class="editor-drawer" role="dialog" aria-modal="true" aria-labelledby="editor-title">
      <div class="editor-header">
        <h3 id="editor-title">Dashboard Editor</h3>
        <button type="button" id="editor-close" class="editor-close" aria-label="Close">&times;</button>
      </div>
      <div class="editor-body">
        <div class="editor-left">
          <div class="editor-section-title">Modules</div>
          <div class="editor-toolbar">
            <button type="button" id="editor-focus-toggle" class="editor-btn">Focus Mode: Off</button>
            <button type="button" id="editor-capture-toggle" class="editor-btn">Modal Capture Mode: Off</button>
          </div>
          <div id="editor-quick-nav" class="editor-quick-nav"></div>
          <div id="editor-modules-list"></div>
          <div class="editor-actions">
            <button type="button" id="editor-save" class="editor-btn primary">Save</button>
            <button type="button" id="editor-validate" class="editor-btn">Validate</button>
            <button type="button" id="editor-export" class="editor-btn">Export JSON</button>
            <button type="button" id="editor-reset" class="editor-btn danger">Reset</button>
          </div>
          <div class="editor-action-status">
            <span id="editor-dirty-chip" class="editor-status-chip dirty hidden">Unsaved changes</span>
            <span id="editor-last-saved-chip" class="editor-status-chip">Last saved: not yet</span>
          </div>
          <p class="editor-note" id="editor-note"></p>
        </div>
        <div class="editor-right">
          <div id="editor-panel"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- JSON configuration for all content -->
  <script id="dashboard-data" type="application/json">
  



{
    "meta":  {
                 "pageTitle":  "Far North Disaster And Emergency Dashboard",
                 "contactNumber":  "0800 920 029",
                 "emergencyNumber":  "111",
                 "lastUpdated":  ""
             },
    "brand":  {
                  "shortCode":  "FN",
                  "councilName":  "Far North District Council",
                  "dashboardTitle":  "Disaster And Emergency Dashboard"
              },
    "hero":  {
                 "taglineTitle":  "Get ready",
                 "description":  "Check live information about weather, roads, power, water and civil defence for the Far North. Always follow official advice from Northland Civil Defence and emergency services.",
                 "statusPill":  "Sample status Normal Monitoring",
                 "emergencyMessage":  "In a life threatening emergency call 111"
             },
    "ctaButtons":  [
                       {
                           "label":  "Receive Notifications",
                           "icon":  "🔔",
                           "url":  "#",
                           "style":  "primary",
                           "external":  false,
                           "action":  "notifications:enable"
                       },
                       {
                           "label":  "View Northland Civil Defence Updates",
                           "icon":  "📣",
                           "url":  "https://www.facebook.com/civildefencenorthland/",
                           "style":  "secondary",
                           "external":  true
                       }
                   ],
    "mapPanel":  {
                     "title":  "Situation Overview Map",
                     "subtitle":  "Example map placeholder",
                     "placeholderText":  "Map placeholder for FNDC or regional GIS viewer"
                 },
    "alertsPanel":  {
                        "title":  "Current Warnings And Alerts",
                        "subtitle":  "Live summary",
                        "lead":  "In an emergency call 111. For evacuation and shelter information follow Northland Civil Defence messages.",
                        "items":  [
                                      {
                                          "label":  "Example",
                                          "description":  "",
                                          "tag":  ""
                                      }
                                  ]
                    },
    "summaryPanel":  {
                         "title":  "Far North Alerts",
                         "paragraphs":  [
                                            "",
                                            "Localised issues can still affect roads, power, water and communications. Use the status cards and tiles below for detailed information."
                                        ],
                         "customBlocks":  [

                                          ]
                     },
    "statsSection":  {
                         "title":  "Current Status",
                         "subtitle":  "Live status overview.",
                         "cards":  [
                                       {
                                           "label":  "Road Closures Local",
                                           "number":  0,
                                           "description":  "Current closures on Far North local roads.",
                                           "url":  "#",
                                           "colorClass":  "teal",
                                           "external":  false,
                                           "ariaLabel":  "- local road closures. View Far North local road closure information."
                                       },
                                       {
                                           "label":  "Road Closures NZTA",
                                           "number":  0,
                                           "description":  "Key impacts on state highways and regional routes.",
                                           "url":  "https://www.journeys.nzta.govt.nz/journey-planner",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- state highway issues. View NZTA state highway information."
                                       },
                                       {
                                           "label":  "Power Outages",
                                           "number":  0,
                                           "description":  "Outages and restoration times on the Top Energy network.",
                                           "url":  "https://outages.topenergy.co.nz/",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- power outages. View Top Energy outage information."
                                       },
                                       {
                                           "label":  "Water Outages",
                                           "number":  0,
                                           "description":  "Planned and unplanned interruptions to council water supply.",
                                           "url":  "https://www.fndc.govt.nz/services/water/Water-outage-updates",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- water outage. View Far North water outage information."
                                       },
                                       {
                                           "label":  "Emergency News Stories",
                                           "number":  0,
                                           "description":  "Recent news stories that relate to emergency events or recovery.",
                                           "url":  "https://www.fndc.govt.nz/council/Latest-news",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- emergency news stories. View Far North emergency news stories."
                                       },
                                       {
                                           "label":  "FNDC Alerts",
                                           "number":  0,
                                           "description":  "Formal council alerts for the Far North District.",
                                           "url":  "https://www.fndc.govt.nz/council/Latest-news",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- Far North District Council alert. View Far North alerts."
                                       },
                                       {
                                           "label":  "Weather Warnings",
                                           "number":  0,
                                           "description":  "MetService warnings that include parts of Northland.",
                                           "url":  "https://www.metservice.com/warnings/home",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- weather warnings. View MetService weather warnings."
                                       },
                                       {
                                           "label":  "Civil Defence Warnings",
                                           "number":  0,
                                           "description":  "National or regional civil defence warnings that affect the Far North.",
                                           "url":  "https://www.civildefence.govt.nz/",
                                           "colorClass":  "teal",
                                           "external":  true,
                                           "ariaLabel":  "- civil defence warnings. View national civil defence information."
                                       }
                                   ]
                     },
    "socialFeedsSection":  {
                               "title":  "Social Media Updates",
                               "subtitle":  "Latest posts from official channels",
                               "note":  "Feeds are loaded from external social media sites and may take a moment to appear.",
                               "tabs":  [
                                            {
                                                "id":  "northland-cd-facebook",
                                                "label":  "Northland Civil Defence",
                                                "type":  "facebook",
                                                "iframeSrc":  "https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2Fcivildefencenorthland\u0026tabs=timeline\u0026width=500\u0026height=600\u0026small_header=false\u0026adapt_container_width=true\u0026hide_cover=false\u0026show_facepile=true"
                                            },
                                            {
                                                "id":  "fndc-facebook",
                                                "label":  "Far North District Council",
                                                "type":  "facebook",
                                                "iframeSrc":  "https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2FFarNorthDistrictCouncil\u0026tabs=timeline\u0026width=900\u0026height=600\u0026small_header=false\u0026adapt_container_width=true\u0026hide_cover=false\u0026show_facepile=true"
                                            },
                                            {
                                                "id":  "met-service",
                                                "label":  "MetService",
                                                "type":  "facebook",
                                                "iframeSrc":  "https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2FMetService\u0026tabs=timeline\u0026width=900\u0026height=600\u0026small_header=false\u0026adapt_container_width=true\u0026hide_cover=false\u0026show_facepile=true"
                                            }
                                        ]
                           },
    "tilesSection":  {
                         "title":  "Key Information",
                         "subtitle":  "Tiles are grouped by local, district, regional and national level services",
                         "groups":  [
                                        {
                                            "id":  "local",
                                            "title":  "Local",
                                            "description":  "Facilities and services close to where you live",
                                            "tiles":  [
                                                          {
                                                              "title":  "Local halls",
                                                              "description":  "Local halls from around the district.",
                                                              "icon":  "🏠",
                                                              "colorClass":  "teal",
                                                              "url":  "https://maorimaps.com/en/marae-map",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "FNDC"
                                                          },
                                                          {
                                                              "title":  "Marae directory",
                                                              "description":  "Local marae from around the district.",
                                                              "icon":  "🏠",
                                                              "colorClass":  "teal",
                                                              "url":  "",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "Marae Maps"
                                                          },
                                                          {
                                                              "title":  "FNDC Service Centres",
                                                              "description":  "Cmmunity facilities from around the district.",
                                                              "icon":  "🏢",
                                                              "colorClass":  "teal",
                                                              "url":  "",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "FNDC"
                                                          },
                                                          {
                                                              "title":  "Radio stations",
                                                              "description":  "Local radio stations",
                                                              "icon":  "📻",
                                                              "colorClass":  "teal",
                                                              "url":  "",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "External site"
                                                          }
                                                      ]
                                        },
                                        {
                                            "id":  "district",
                                            "title":  "District",
                                            "description":  "Far North District Council information",
                                            "tiles":  [
                                                          {
                                                              "title":  "Council news",
                                                              "description":  "Service updates and council alerts.",
                                                              "icon":  "📰",
                                                              "colorClass":  "grey",
                                                              "url":  "https://www.fndc.govt.nz/council/Latest-news",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "FNDC"
                                                          },
                                                          {
                                                              "title":  "Local Road Closures",
                                                              "description":  "Far North local roads, slips and closures.",
                                                              "icon":  "🚧",
                                                              "colorClass":  "grey",
                                                              "url":  "#",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  ""
                                                          },
                                                          {
                                                              "title":  "Water Outages",
                                                              "description":  "Planned and unplanned interruptions to council water supply.",
                                                              "icon":  "🚧",
                                                              "colorClass":  "grey",
                                                              "url":  "https://www.fndc.govt.nz/services/water/Water-outage-updates",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "FNDC"
                                                          }
                                                      ]
                                        },
                                        {
                                            "id":  "regional",
                                            "title":  "Regional",
                                            "description":  "Northland wide services and lifelines",
                                            "tiles":  [
                                                          {
                                                              "title":  "Power Outages",
                                                              "description":  "Current outages on the Top Energy network in the Far North.",
                                                              "icon":  "🔌",
                                                              "colorClass":  "blue",
                                                              "url":  "https://outages.topenergy.co.nz/",
                                                              "external":  true,
                                                              "metaTop":  "0",
                                                              "metaBottom":  "Top Energy"
                                                          },
                                                          {
                                                              "title":  "Enviromental data",
                                                              "description":  "NRC river levels, rainfall gauges and coastal monitoring.",
                                                              "icon":  "🌳",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "NRC data"
                                                          },
                                                          {
                                                              "title":  "SwimSafe",
                                                              "description":  "Safeswim provides live information on the conditions at many of the popular swimming sites around Northland.",
                                                              "icon":  "🛟",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "NRC data"
                                                          },
                                                          {
                                                              "title":  "Chorus network status",
                                                              "description":  "See network status of the Chorus network.",
                                                              "icon":  "📱",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "NRC data"
                                                          },
                                                          {
                                                              "title":  "Spark network status",
                                                              "description":  "See network status of the Spark network.",
                                                              "icon":  "📱",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "Spark"
                                                          },
                                                          {
                                                              "title":  "One network status",
                                                              "description":  "See network status of the One network.",
                                                              "icon":  "📱",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "One"
                                                          },
                                                          {
                                                              "title":  "2degrees network status",
                                                              "description":  "See network status of the 2degrees network.",
                                                              "icon":  "📱",
                                                              "colorClass":  "blue",
                                                              "url":  "https://www.nrc.govt.nz/environment/environmental-data/environmental-data-hub/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "2degrees"
                                                          }
                                                      ]
                                        },
                                        {
                                            "id":  "national",
                                            "title":  "National",
                                            "description":  "Nationwide networks and guidance",
                                            "tiles":  [
                                                          {
                                                              "title":  "State Highways",
                                                              "description":  "NZTA journey planner for highways in and out of the district.",
                                                              "icon":  "🛣",
                                                              "colorClass":  "red",
                                                              "url":  "https://www.journeys.nzta.govt.nz/journey-planner",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "NZTA"
                                                          },
                                                          {
                                                              "title":  "Weather warnings",
                                                              "description":  "See MetService weather warnings.",
                                                              "icon":  "⛈️",
                                                              "colorClass":  "red",
                                                              "url":  "https://www.journeys.nzta.govt.nz/journey-planner",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "MetService"
                                                          },
                                                          {
                                                              "title":  "Civil Defence",
                                                              "description":  "Civil Defence",
                                                              "icon":  "",
                                                              "colorClass":  "red",
                                                              "url":  "https://www.journeys.nzta.govt.nz/journey-planner",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "Civil Defence"
                                                          },
                                                          {
                                                              "title":  "Get Ready",
                                                              "description":  "Preparedness guides and checklists for your whanau.",
                                                              "icon":  "",
                                                              "colorClass":  "red",
                                                              "url":  "https://getready.govt.nz/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "National guidance"
                                                          },
                                                          {
                                                              "title":  "GeoNet",
                                                              "description":  "GeoNet",
                                                              "icon":  "🫨",
                                                              "colorClass":  "red",
                                                              "url":  "https://getready.govt.nz/",
                                                              "external":  true,
                                                              "metaTop":  "",
                                                              "metaBottom":  "GeoNet"
                                                          }
                                                      ]
                                        }
                                    ],
                         "quickLinks":  [
                                            {
                                                "label":  "In an emergency",
                                                "url":  ""
                                            },
                                            {
                                                "label":  "Get prepared",
                                                "url":  ""
                                            },
                                            {
                                                "label":  "Get involved",
                                                "url":  ""
                                            },
                                            {
                                                "label":  "Get Ready",
                                                "url":  ""
                                            }
                                        ]
                     },
    "footer":  {
                   "line1":  "Accessibility | Far North District Council disaster and emergency dashboard example.",
                   "line2":  "Data links open external sites in a new tab."
               },
    "layout":  {
                   "edit":  {
                                "enabled":  true,
                                "storageKey":  "fned_dashboard_override_v1",
                                "showButton":  true,
                                "requireQueryParam":  false,
                                "queryParam":  "edit"
                            },
                   "modules":  [
                                   {
                                       "id":  "header",
                                       "label":  "Header",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "hero",
                                       "label":  "Hero",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "ctaRow",
                                       "label":  "Action Buttons",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "situation",
                                       "label":  "Map And Alerts",
                                       "enabled":  true,
                                       "submodules":  [
                                                          {
                                                              "id":  "mapPanel",
                                                              "label":  "Map Panel",
                                                              "enabled":  true
                                                          },
                                                          {
                                                              "id":  "alertsPanel",
                                                              "label":  "Alerts Panel",
                                                              "enabled":  true
                                                          }
                                                      ]
                                   },
                                   {
                                       "id":  "summary",
                                       "label":  "Content Panel",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "stats",
                                       "label":  "Status Cards",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "tiles",
                                       "label":  "Information Tiles",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "social",
                                       "label":  "Social Updates",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   },
                                   {
                                       "id":  "footer",
                                       "label":  "Footer",
                                       "enabled":  true,
                                       "submodules":  [

                                                      ]
                                   }
                               ]
               },
    "runtimeConfig":  {
                          "summary":  {
                                          "includeEmergencyBanners":  true,
                                          "showFeedHealth":  false,
                                          "enableSummaryCollapse":  true,
                                          "summaryCollapsedByDefault":  true,
                                          "farNorthAlertsSinceDays":  14
                                      },
                          "tiles":  {
                                        "mobileColumns":  2
                                    },
                          "stats":  {
                                        "enableLiveCounts":  true,
                                        "autoRefreshEnabled":  true,
                                        "refreshIntervalMs":  120000,
                                        "showConnectionStatus":  true,
                                        "showLastUpdated":  true,
                                        "liveCountSources":  {
                                                                 "fndcAlerts":  true,
                                                                 "emergencyNews":  true,
                                                                 "waterOutages":  true,
                                                                 "powerOutages":  true,
                                                                 "nztaRoadClosures":  true,
                                                                 "localRoadClosures":  true,
                                                                 "weatherWarnings":  true,
                                                                 "civilDefenceWarnings":  true
                                                             },
                                        "waterOutageStatusFilter":  [
                                                                        "Reported"
                                                                    ],
                                        "waterOutageTypeFilter":  [

                                                                  ],
                                        "powerOutageStatusFilter":  [
                                                                        "unplanned",
                                                                        "plannedActive"
                                                                    ],
                                        "statusTargetUrls":  {
                                                                 "fndcAlerts":  "https://www.fndc.govt.nz/",
                                                                 "emergencyNews":  "https://www.fndc.govt.nz/Whats-New/Latest-news",
                                                                 "waterOutages":  "https://www.fndc.govt.nz/services/water/Water-outage-updates",
                                                                 "powerOutages":  "https://outages.topenergy.co.nz/",
                                                                 "nztaRoadClosures":  "https://www.journeys.nzta.govt.nz/journey-planner",
                                                                 "localRoadClosures":  "https://www.fndc.govt.nz/services/transport/closures",
                                                                 "weatherWarnings":  "https://www.metservice.com/warnings/home",
                                                                 "civilDefenceWarnings":  "https://www.civildefence.govt.nz/"
                                                             },
                                        "fndcAlertsSinceDays":  14,
                                        "emergencyNewsSinceDays":  14
                                    },
                          "regionWarnings":  {
                                                 "showExpiredAlerts":  false,
                                                 "showNonFarNorthAlerts":  false,
                                                 "requireOnsetWithinWindow":  true,
                                                 "hourWindow":  24,
                                                 "proxy":  "https://corsproxy.io/?",
                                                 "metServiceSourceUrl":  "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/alerts/latest.xml",
                                                 "enableCivilDefenceAlerts":  true,
                                                 "civilDefenceAtomUrl":  "https://www.civildefence.govt.nz/home/rss",
                                                 "showCancelledCivilDefenceAlerts":  false,
                                                 "showCustomGeoJsonAlerts":  false,
                                                 "useProxyForCustomGeoJson":  true,
                                                 "disableFarNorthAlerts":  false,
                                                 "useProxyForLinzAreas":  true,
                                                 "linzForceBundledSource":  true,
                                                 "linzSuburbLayerUrl":  "https://data.linz.govt.nz/services;key=27a1097e44b44690a5c7726aa065a076/wfs/layer-113763/",
                                                 "linzApiKey":  "27a1097e44b44690a5c7726aa065a076",
                                                 "linzApiKeyParam":  "api_key",
                                                 "linzWfsTypeName":  "layer-113763"
                                             },
                          "map":  {
                                      "layersControlCollapsed":  true,
                                      "powerOutageStatusFilter":  [
                                                                      "unplanned",
                                                                      "plannedActive"
                                                                  ],
                                      "waterOutageStatusFilter":  [
                                                                      "New",
                                                                      "Reported",
                                                                      "Under repairs",
                                                                      "Planned"
                                                                  ],
                                      "symbolSize":  44,
                                      "symbolFontSize":  22,
                                      "symbolBorderWidth":  2,
                                      "clusterSymbolSize":  44,
                                      "clusterSymbolFontSize":  22,
                                      "maraeClusterEnabled":  true,
                                      "maraeClusterBaseRadiusMeters":  2200,
                                      "maraeClusterMaxRadiusMeters":  60000,
                                      "maraeClusterBaseZoom":  8,
                                      "maraeClusterZoomStepMultiplier":  1.7,
                                      "maraeClusterViewportWidthFactor":  0.12,
                                      "maraeClusterMinCount":  2,
                                      "powerClusterEnabled":  true,
                                      "powerClusterBaseRadiusMeters":  420,
                                      "powerClusterMaxRadiusMeters":  18000,
                                      "powerClusterBaseZoom":  8,
                                      "powerClusterZoomStepMultiplier":  1.55,
                                      "powerClusterViewportWidthFactor":  0.08,
                                      "powerClusterMinCount":  2,
                                      "waterClusterEnabled":  true,
                                      "waterClusterBaseRadiusMeters":  420,
                                      "waterClusterMaxRadiusMeters":  18000,
                                      "waterClusterBaseZoom":  8,
                                      "waterClusterZoomStepMultiplier":  1.55,
                                      "waterClusterViewportWidthFactor":  0.08,
                                      "waterClusterMinCount":  2,
                                      "nztaClusterEnabled":  true,
                                      "nztaClusterBaseRadiusMeters":  450,
                                      "nztaClusterMaxRadiusMeters":  22000,
                                      "nztaClusterBaseZoom":  8,
                                      "nztaClusterZoomStepMultiplier":  1.55,
                                      "nztaClusterViewportWidthFactor":  0.09,
                                      "nztaClusterMinCount":  2,
                                      "localRoadClusterEnabled":  true,
                                      "localRoadClusterBaseRadiusMeters":  400,
                                      "localRoadClusterMaxRadiusMeters":  20000,
                                      "localRoadClusterBaseZoom":  8,
                                      "localRoadClusterZoomStepMultiplier":  1.55,
                                      "localRoadClusterViewportWidthFactor":  0.08,
                                      "localRoadClusterMinCount":  2,
                                      "baseStyle":  "hybrid",
                                      "legendPosition":  "below",
                                      "enabledOverlays":  null,
                                      "defaultVisibleOverlays":  null,
                                      "collisionAvoidanceEnabled":  true,
                                      "collisionBufferPx":  6
                                  },
                          "notifications":  {
                                                "enabled":  true,
                                                "autoRefreshWarnings":  true,
                                                "pollIntervalMs":  30000,
                                                "notifySources":  {
                                                                      "metservice":  true,
                                                                      "civilDefence":  true
                                                                  },
                                                "notifyUpcoming":  true,
                                                "notifyExpired":  false,
                                                "dedupeWindowHours":  12,
                                                "useBrowserNotifications":  true,
                                                "useToasts":  true,
                                                "toastDurationMs":  9000,
                                                "debugLog":  false
                                            },
                          "customMessages":  {
                                                 "enabled":  true,
                                                 "url":  "https://raw.githubusercontent.com/almokinsgov/FNDC_closures/main/fned_custom_messages_example.json",
                                                 "pollIntervalMs":  30000,
                                                 "renderInSummary":  true,
                                                 "useBrowserNotifications":  true,
                                                 "useToasts":  true,
                                                 "dedupeWindowHours":  12,
                                                 "debugLog":  false
                                             }
                      }
}



  
  </script>

  <script src="./editor_config_utils.js"></script>
  <script src="./endpoints.js"></script>
  <script src="./fetch_helpers.js"></script>

  <!-- Renderer -->
  <script>
    (function () {
      const dataEl = document.getElementById("dashboard-data");
      let data = JSON.parse(dataEl.textContent);

      const DEFAULT_STORAGE_KEY = "fned_dashboard_override_v1";
      const STORAGE_KEY = (data.layout && data.layout.edit && data.layout.edit.storageKey)
        ? data.layout.edit.storageKey
        : DEFAULT_STORAGE_KEY;

      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && typeof parsed === "object") {
            data = parsed;
          }
        }
      } catch (err) {
        console.warn("Saved dashboard config could not be loaded", err);
      }

      var editorConfigUtils = window.FNED_EDITOR_CONFIG_UTILS || null;
      if (editorConfigUtils && typeof editorConfigUtils.sanitizeDashboardConfig === "function") {
        var sanitisedLoad = editorConfigUtils.sanitizeDashboardConfig(data);
        if (sanitisedLoad && sanitisedLoad.data) {
          data = sanitisedLoad.data;
        }
      }

      var runtimeConfig = data.runtimeConfig || {};
      var endpointsApi = window.FNED_ENDPOINTS_API || null;
      var resolvedEndpoints = null;
      if (endpointsApi && typeof endpointsApi.resolve === "function") {
        resolvedEndpoints = endpointsApi.resolve(runtimeConfig, window.location);
      }

      window.FNED_STORAGE_KEY = STORAGE_KEY;
      window.FNED_DASHBOARD_DATA = data;
      window.FNED_CONFIG = runtimeConfig;
      window.FNED_ENDPOINTS = resolvedEndpoints || {};

      window.FNED_APP = {
        getData: function () {
          return JSON.parse(JSON.stringify(window.FNED_DASHBOARD_DATA));
        },
        validateData: function (candidateData) {
          if (!editorConfigUtils || typeof editorConfigUtils.sanitizeDashboardConfig !== "function") {
            return {
              data: candidateData,
              validation: { errors: [], warnings: [] }
            };
          }
          return editorConfigUtils.sanitizeDashboardConfig(candidateData);
        },
        saveDataAndReload: function (nextData) {
          var payload = nextData;
          if (editorConfigUtils && typeof editorConfigUtils.sanitizeDashboardConfig === "function") {
            var sanitisedSave = editorConfigUtils.sanitizeDashboardConfig(nextData);
            payload = sanitisedSave && sanitisedSave.data ? sanitisedSave.data : nextData;
          }
          window.FNED_DASHBOARD_DATA = payload;
          function cleanupFnedStorageForRetry() {
            var removed = [];
            var keepKey = STORAGE_KEY;
            var keepMetaKey = STORAGE_KEY + "_last_saved_at";
            var allKeys = [];
            for (var i = 0; i < localStorage.length; i++) {
              var key = localStorage.key(i);
              if (key) allKeys.push(key);
            }
            allKeys.forEach(function (key) {
              var isDashboardOverride = /^fned_dashboard_override_v[0-9]+$/.test(key);
              var isDashboardMeta = /^fned_dashboard_override_v[0-9]+_last_saved_at$/.test(key);
              var isStaleDashboardValue = isDashboardOverride && key !== keepKey;
              var isStaleDashboardMeta = isDashboardMeta && key !== keepMetaKey;
              var isCurrentMeta = key === keepMetaKey;
              if (isStaleDashboardValue || isStaleDashboardMeta || isCurrentMeta) {
                try {
                  localStorage.removeItem(key);
                  removed.push(key);
                } catch (_removeError) {
                  // Ignore individual key cleanup failures.
                }
              }
            });
            return removed;
          }
          function buildCompactPayloadForStorage(inputPayload) {
            var compact = JSON.parse(JSON.stringify(inputPayload || {}));
            var rw = compact && compact.runtimeConfig && compact.runtimeConfig.regionWarnings
              ? compact.runtimeConfig.regionWarnings
              : null;
            if (!rw || typeof rw !== "object") return compact;
            // In bundled LINZ mode these are fixed defaults, so omit them to reduce stored payload size.
            if (rw.linzForceBundledSource !== false) {
              delete rw.linzSuburbLayerUrl;
              delete rw.linzApiKey;
              delete rw.linzApiKeyParam;
              delete rw.linzWfsTypeName;
              delete rw.linzForceBundledSource;
            }
            return compact;
          }
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          } catch (saveError) {
            var isQuotaExceeded = !!(
              saveError &&
              (saveError.name === "QuotaExceededError" || saveError.code === 22 || saveError.code === 1014)
            );
            var removedKeys = [];
            if (isQuotaExceeded) {
              removedKeys = cleanupFnedStorageForRetry();
              try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                try {
                  localStorage.setItem(STORAGE_KEY + "_last_saved_at", new Date().toISOString());
                } catch (_metaErrorRetry) {
                  // Ignore metadata timestamp failures.
                }
                location.reload();
                return { ok: true, recoveredFromQuota: true, removedKeys: removedKeys };
              } catch (_retryError) {
                // Retry failed; attempt compact payload fallback.
                try {
                  var compactPayload = buildCompactPayloadForStorage(payload);
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(compactPayload));
                  window.FNED_DASHBOARD_DATA = compactPayload;
                  try {
                    localStorage.setItem(STORAGE_KEY + "_last_saved_at", new Date().toISOString());
                  } catch (_metaErrorCompact) {
                    // Ignore metadata timestamp failures.
                  }
                  location.reload();
                  return { ok: true, recoveredFromQuota: true, usedCompactPayload: true, removedKeys: removedKeys };
                } catch (_compactRetryError) {
                  // Compact retry failed; return error below.
                }
              }
            }
            return {
              ok: false,
              error: isQuotaExceeded ? "quota_exceeded" : "storage_write_failed",
              message: (saveError && saveError.message) ? String(saveError.message) : "Unknown storage error",
              removedKeys: removedKeys
            };
          }
          try {
            localStorage.setItem(STORAGE_KEY + "_last_saved_at", new Date().toISOString());
          } catch (_metaError) {
            // Ignore metadata timestamp failures.
          }
          location.reload();
          return { ok: true };
        },
        resetDataAndReload: function () {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      };

      function createFeedStatusApi() {
        var records = Object.create(null);
        var panelListEl = null;

        function nowIso() {
          return new Date().toISOString();
        }

        function normalizeError(error) {
          if (!error) return "Unknown error";
          if (typeof error === "string") return error;
          if (error.message) return String(error.message);
          try {
            return JSON.stringify(error);
          } catch (_jsonError) {
            return "Unknown error";
          }
        }

        function statusRank(status) {
          if (status === "failed") return 0;
          if (status === "loading") return 1;
          return 2;
        }

        function getOrCreate(key) {
          var existing = records[key];
          if (existing) return existing;
          records[key] = {
            key: key,
            status: "idle",
            attempts: 0,
            url: "",
            updatedAt: "",
            lastSuccessAt: "",
            lastFailureAt: "",
            httpStatus: null,
            message: ""
          };
          return records[key];
        }

        function getSummary(snapshot) {
          var counts = { ok: 0, failed: 0, loading: 0 };
          snapshot.forEach(function (item) {
            if (item.status === "ok") counts.ok += 1;
            else if (item.status === "failed") counts.failed += 1;
            else if (item.status === "loading") counts.loading += 1;
          });
          return counts;
        }

        function sortedSnapshot() {
          return Object.keys(records)
            .map(function (key) { return records[key]; })
            .sort(function (a, b) {
              var rankDiff = statusRank(a.status) - statusRank(b.status);
              if (rankDiff !== 0) return rankDiff;
              return (a.key || "").localeCompare(b.key || "");
            });
        }

        function renderPanel() {
          if (!panelListEl) return;
          var snapshot = sortedSnapshot();
          if (!snapshot.length) {
            panelListEl.innerHTML = "<li>No tracked feeds yet.</li>";
            return;
          }

          var summary = getSummary(snapshot);
          var html = [
            "<li><strong>OK:</strong> " + summary.ok +
              " | <strong>Failed:</strong> " + summary.failed +
              " | <strong>Loading:</strong> " + summary.loading + "</li>"
          ];

          snapshot.slice(0, 8).forEach(function (item) {
            var statusLabel = (item.status || "idle").toUpperCase();
            var detail = "";
            if (item.status === "failed" && item.message) {
              detail = " - " + item.message;
            } else if (item.httpStatus) {
              detail = " - HTTP " + item.httpStatus;
            }
            html.push("<li><code>" + item.key + "</code>: " + statusLabel + detail + "</li>");
          });

          panelListEl.innerHTML = html.join("");
        }

        function setPanelElement(el) {
          panelListEl = el || null;
          renderPanel();
        }

        function start(key, url) {
          var item = getOrCreate(key);
          item.status = "loading";
          item.url = url || item.url || "";
          item.updatedAt = nowIso();
          item.attempts += 1;
          item.httpStatus = null;
          item.message = "";
          renderPanel();
        }

        function ok(key, meta) {
          var item = getOrCreate(key);
          item.status = "ok";
          item.updatedAt = nowIso();
          item.lastSuccessAt = item.updatedAt;
          item.httpStatus = meta && meta.httpStatus ? meta.httpStatus : null;
          item.message = "";
          renderPanel();
        }

        function fail(key, error, meta) {
          var item = getOrCreate(key);
          item.status = "failed";
          item.updatedAt = nowIso();
          item.lastFailureAt = item.updatedAt;
          item.httpStatus = meta && meta.httpStatus ? meta.httpStatus : (error && error.httpStatus ? error.httpStatus : null);
          item.message = normalizeError(error);
          renderPanel();
        }

        return {
          start: start,
          ok: ok,
          fail: fail,
          setPanelElement: setPanelElement,
          getSnapshot: sortedSnapshot
        };
      }

      if (!window.FNED_FEED_STATUS_API) {
        window.FNED_FEED_STATUS_API = createFeedStatusApi();
      }

      function fetchTextWithFeedStatus(feedKey, url, options) {
        var api = window.FNED_FEED_STATUS_API;
        var sharedFetch = window.FNED_FETCH;

        if (sharedFetch && typeof sharedFetch.fetchText === "function") {
          return sharedFetch.fetchText(url, {
            fetchOptions: options || {},
            feedKey: feedKey,
            feedStatusApi: api,
            timeoutMs: 15000,
            retries: 1
          });
        }

        if (api && typeof api.start === "function") {
          api.start(feedKey, url);
        }

        return fetch(url, options).then(function (response) {
          if (!response.ok) {
            var httpError = new Error("HTTP " + response.status + " " + response.statusText);
            httpError.httpStatus = response.status;
            throw httpError;
          }
          return response.text().then(function (text) {
            if (api && typeof api.ok === "function") {
              api.ok(feedKey, { httpStatus: response.status });
            }
            return text;
          });
        }).catch(function (error) {
          if (api && typeof api.fail === "function") {
            api.fail(feedKey, error, { httpStatus: error && error.httpStatus ? error.httpStatus : null });
          }
          throw error;
        });
      }

      function fetchJsonWithFeedStatus(feedKey, url, options) {
        var api = window.FNED_FEED_STATUS_API;
        var sharedFetch = window.FNED_FETCH;

        if (sharedFetch && typeof sharedFetch.fetchJson === "function") {
          return sharedFetch.fetchJson(url, {
            fetchOptions: options || {},
            feedKey: feedKey,
            feedStatusApi: api,
            timeoutMs: 15000,
            retries: 1
          });
        }

        if (api && typeof api.start === "function") {
          api.start(feedKey, url);
        }

        return fetch(url, options).then(function (response) {
          if (!response.ok) {
            var httpError = new Error("HTTP " + response.status + " " + response.statusText);
            httpError.httpStatus = response.status;
            throw httpError;
          }
          return response.json().then(function (payload) {
            if (api && typeof api.ok === "function") {
              api.ok(feedKey, { httpStatus: response.status });
            }
            return payload;
          });
        }).catch(function (error) {
          if (api && typeof api.fail === "function") {
            api.fail(feedKey, error, { httpStatus: error && error.httpStatus ? error.httpStatus : null });
          }
          throw error;
        });
      }

      function ensureFeedHealthPanel() {
        var showFeedHealth = true;
        try {
          var summaryRuntime = data && data.runtimeConfig && data.runtimeConfig.summary
            ? data.runtimeConfig.summary
            : {};
          showFeedHealth = summaryRuntime.showFeedHealth !== false;
        } catch (_feedHealthCfgErr) {
          showFeedHealth = true;
        }

        var alertBody = document.querySelector(".alert-body");
        if (!alertBody) {
          return;
        }

        if (!showFeedHealth) {
          var existingWrap = alertBody.querySelector(".feed-health");
          if (existingWrap && existingWrap.parentNode) {
            existingWrap.parentNode.removeChild(existingWrap);
          }
          if (window.FNED_FEED_STATUS_API && typeof window.FNED_FEED_STATUS_API.setPanelElement === "function") {
            window.FNED_FEED_STATUS_API.setPanelElement(null);
          }
          return;
        }

        var listEl = document.getElementById("feed-health-list");
        if (!listEl) {
          var wrap = document.createElement("div");
          wrap.className = "feed-health";

          var title = document.createElement("p");
          title.className = "feed-health-heading";
          title.textContent = "Feed health";

          listEl = document.createElement("ul");
          listEl.id = "feed-health-list";
          listEl.className = "feed-health-list";

          wrap.appendChild(title);
          wrap.appendChild(listEl);
          alertBody.appendChild(wrap);
        }

        if (window.FNED_FEED_STATUS_API && typeof window.FNED_FEED_STATUS_API.setPanelElement === "function") {
          window.FNED_FEED_STATUS_API.setPanelElement(listEl);
        }
      }

      function setupSummaryCollapseControl(summaryContainer) {
        if (!summaryContainer) {
          return;
        }

        var summaryRuntime = data && data.runtimeConfig && data.runtimeConfig.summary
          ? data.runtimeConfig.summary
          : {};
        var collapseEnabled = summaryRuntime.enableSummaryCollapse !== false;
        var startCollapsed = !!summaryRuntime.summaryCollapsedByDefault;

        var existingApi = window.FNED_SUMMARY_COLLAPSE_API;
        if (existingApi && typeof existingApi.disconnect === "function") {
          existingApi.disconnect();
        }

        var existingBtn = document.getElementById("summary-collapse-toggle");
        if (!collapseEnabled) {
          if (existingBtn && existingBtn.parentNode) {
            existingBtn.parentNode.removeChild(existingBtn);
          }
          var allCards = summaryContainer.querySelectorAll(".summary-banner.alert-card");
          allCards.forEach(function (card) {
            card.hidden = false;
            card.classList.remove("summary-alert-hidden");
          });
          window.FNED_SUMMARY_COLLAPSE_API = null;
          return;
        }

        var titleEl = document.getElementById("summary-title");
        if (!titleEl || !titleEl.parentNode) {
          return;
        }

        var toggleBtn = existingBtn;
        if (!toggleBtn) {
          toggleBtn = document.createElement("button");
          toggleBtn.type = "button";
          toggleBtn.id = "summary-collapse-toggle";
          toggleBtn.className = "summary-collapse-toggle";
          titleEl.parentNode.insertBefore(toggleBtn, titleEl.nextSibling);
        }

        var collapsed = startCollapsed;
        var observer = null;

        function getCards() {
          return Array.from(summaryContainer.querySelectorAll(".summary-banner.alert-card"));
        }

        function apply() {
          var cards = getCards();
          var extraCount = Math.max(0, cards.length - 1);
          if (cards.length <= 1) {
            cards.forEach(function (card) {
              card.hidden = false;
              card.classList.remove("summary-alert-hidden");
            });
            toggleBtn.hidden = true;
            return;
          }

          toggleBtn.hidden = false;
          cards.forEach(function (card, index) {
            var hide = collapsed && index > 0;
            card.hidden = hide;
            card.classList.toggle("summary-alert-hidden", hide);
          });

          toggleBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
          toggleBtn.textContent = collapsed
            ? ("Show all alerts (" + String(extraCount) + " more)")
            : "Collapse alerts";
        }

        toggleBtn.onclick = function () {
          collapsed = !collapsed;
          apply();
        };

        observer = new MutationObserver(function () {
          apply();
        });
        observer.observe(summaryContainer, { childList: true, subtree: true });

        window.FNED_SUMMARY_COLLAPSE_API = {
          refresh: apply,
          disconnect: function () {
            if (observer) {
              observer.disconnect();
              observer = null;
            }
          }
        };

        apply();
      }



      // Endpoint for emergency banners that drive the summary panel
      var summaryEndpoints = (window.FNED_ENDPOINTS && window.FNED_ENDPOINTS.summary)
        ? window.FNED_ENDPOINTS.summary
        : {};
      var mapEndpoints = (window.FNED_ENDPOINTS && window.FNED_ENDPOINTS.map)
        ? window.FNED_ENDPOINTS.map
        : {};

      const EMERGENCY_BANNERS_ENDPOINT =
        summaryEndpoints.emergencyBannersSource ||
        "https://www.fndc.govt.nz/Apps/emergencybanners";
      const EMERGENCY_BANNERS_URL =
        summaryEndpoints.emergencyBanners ||
        ((location.hostname === "www.fndc.govt.nz" || location.hostname.endsWith(".fndc.govt.nz"))
          ? EMERGENCY_BANNERS_ENDPOINT
          : "https://corsproxy.io/?url=" + encodeURIComponent(EMERGENCY_BANNERS_ENDPOINT));
		  
	// Endpoint for emergency news stories
const EMERGENCY_STORIES_URL =
  summaryEndpoints.emergencyStories ||
  "https://corsproxy.io/?url=https://www.fndc.govt.nz/Apps/emergencystories";	  
		 

	// Endpoint for water outages
 const WATER_OUTAGES_URL =
  summaryEndpoints.waterOutages ||
  "https://corsproxy.io/?url=https://www.fndc.govt.nz/services/water/Water-outage-updates/wateroutagesassetlistingfeed";	  		 
  const TOP_ENERGY_OUTAGES_URL =
    mapEndpoints.topEnergyOutages ||
    "https://corsproxy.io/?url=" + encodeURIComponent("https://outages.topenergy.co.nz/api/outages");
  const TOP_ENERGY_REGIONS_URL =
    mapEndpoints.topEnergyRegions ||
    "https://outages.topenergy.co.nz/api/outages/regions";
  const NZTA_DELAYS_STATUS_URL =
    mapEndpoints.nztaDelays ||
    mapEndpoints.nztaDelaysSource ||
    "https://corsproxy.io/?url=https://www.journeys.nzta.govt.nz/assets/map-data-cache/delays.json";
  const LOCAL_ROAD_CLOSURES_STATUS_SOURCE_URL =
    mapEndpoints.localRoadClosuresSource ||
    "https://raw.githubusercontent.com/almokinsgov/rammtojson/refs/heads/main/public/public_closures_FNDC.json";
  const LOCAL_ROAD_CLOSURES_STATUS_URL =
    mapEndpoints.localRoadClosures ||
    LOCAL_ROAD_CLOSURES_STATUS_SOURCE_URL ||
    "https://raw.githubusercontent.com/almokinsgov/rammtojson/refs/heads/main/public/public_closures_FNDC.json";
		  
      // Meta and brand
      document.title = data.meta.pageTitle;
      document.getElementById("brand-logo").textContent = data.brand.shortCode;
      document.getElementById("brand-council").textContent = data.brand.councilName;
      document.getElementById("brand-dashboard").textContent = data.brand.dashboardTitle;

      document.getElementById("header-contact").textContent =
        "Contact council " + data.meta.contactNumber;
      document.getElementById("header-emergency").textContent =
        "In an emergency call " + data.meta.emergencyNumber;

      // Hero
      document.getElementById("hero-title").textContent = data.hero.taglineTitle;
      document.getElementById("hero-description").textContent = data.hero.description;
      document.getElementById("hero-pill").textContent = data.hero.statusPill;
      document.getElementById("hero-emergency-message").textContent = data.hero.emergencyMessage;
      document.getElementById("hero-last-updated").textContent =
        "Last updated " + data.meta.lastUpdated;

      // CTA buttons
      const ctaRow = document.getElementById("cta-row");
      data.ctaButtons.forEach(function (btn) {
        const a = document.createElement("a");
        a.className = "cta-btn" + (btn.style === "secondary" ? " secondary" : "");
        a.setAttribute("role", "button");

        const isNotificationAction =
          btn &&
          typeof btn.action === "string" &&
          btn.action.toLowerCase().indexOf("notifications") === 0;

        if (isNotificationAction) {
          a.href = "#";
          a.setAttribute("data-fned-action", btn.action);
          a.setAttribute("data-base-label", btn.label || "");
          if (btn.action === "notifications:enable" && !document.getElementById("fned-cta-notifications")) {
            a.id = "fned-cta-notifications";
          }
          a.addEventListener("click", function (ev) {
            ev.preventDefault();
            if (window.FNED_NOTIFICATIONS_API && typeof window.FNED_NOTIFICATIONS_API.enableFromCta === "function") {
              window.FNED_NOTIFICATIONS_API.enableFromCta();
            } else if (window.FNED_NOTIFICATIONS_API && typeof window.FNED_NOTIFICATIONS_API.requestPermission === "function") {
              window.FNED_NOTIFICATIONS_API.requestPermission();
            }
          });
        } else {
          a.href = btn.url || "#";
          if (btn.external) {
            a.target = "_blank";
            a.rel = "noopener";
          }
        }

        const iconSpan = document.createElement("span");
        iconSpan.className = "icon";
        iconSpan.setAttribute("aria-hidden", "true");
        iconSpan.textContent = btn.icon || "";

        const textSpan = document.createElement("span");
        textSpan.textContent = btn.label;

        a.appendChild(iconSpan);
        a.appendChild(textSpan);
        ctaRow.appendChild(a);
      });

      // Map panel
// Map panel
if (data.mapPanel) {
  var mapHeadingEl = document.getElementById("map-heading");
  var mapSubtitleEl = document.getElementById("map-subtitle");
  var mapPlaceholder = document.getElementById("map-placeholder");

  if (mapHeadingEl) {
    mapHeadingEl.textContent = data.mapPanel.title || "";
  }
  if (mapSubtitleEl) {
    mapSubtitleEl.textContent = data.mapPanel.subtitle || "";
  }

  if (mapPlaceholder) {
    var ariaLabel =
      data.mapPanel.placeholderText ||
      "Far North situation overview map";

    mapPlaceholder.innerHTML =
      '<div id="situation-map" role="region" aria-label="' +
      ariaLabel +
      '"></div>';
  }
}


      // Alerts panel
document.getElementById("alerts-heading").textContent = data.alertsPanel.title;
document.getElementById("alerts-subtitle").textContent = data.alertsPanel.subtitle;
document.getElementById("alerts-lead").innerHTML =
  "<strong>" + data.alertsPanel.lead.split(".")[0] + ".</strong> " +
  data.alertsPanel.lead.split(".").slice(1).join(".").trim();

// Let Region Warnings And Alerts populate the list once feeds are loaded
const alertList = document.getElementById("alert-list");
if (alertList) {
  alertList.innerHTML = "<li class=\"alert-list-meta\"><small>Loading live region warnings and alerts...</small></li>";
}
ensureFeedHealthPanel();


            // Summary panel
      document.getElementById("summary-title").textContent = data.summaryPanel.title;
      const summaryContainer = document.getElementById("summary-paragraphs");
      data.summaryPanel.paragraphs.forEach(function (text) {
        const p = document.createElement("p");
        p.textContent = text;
        summaryContainer.appendChild(p);
      });
      setupSummaryCollapseControl(summaryContainer);

      // Pull any current emergency banners into the summary panel as extra lines
      const includeEmergencyBanners = !(
        data.runtimeConfig &&
        data.runtimeConfig.summary &&
        data.runtimeConfig.summary.includeEmergencyBanners === false
      );
      if (includeEmergencyBanners) {
        loadEmergencyBannersIntoSummary(summaryContainer);
      }

      // Optional custom content blocks (HTML) below the main summary
      const customBlocksEl = document.getElementById("summary-custom-blocks");
      if (customBlocksEl) {
        customBlocksEl.innerHTML = "";
        (data.summaryPanel.customBlocks || []).forEach(function (block) {
          const wrap = document.createElement("div");
          wrap.style.marginTop = "0.75rem";
          wrap.style.paddingTop = "0.75rem";
          wrap.style.borderTop = "1px solid #eceff1";
          if (block && block.title) {
            const h = document.createElement("h4");
            h.textContent = block.title;
            h.style.margin = "0 0 0.35rem 0";
            h.style.fontSize = "0.95rem";
            wrap.appendChild(h);
          }
          const content = document.createElement("div");
          content.innerHTML = block && block.html ? block.html : "";
          wrap.appendChild(content);
          customBlocksEl.appendChild(wrap);
        });
      }

          // Stats Section
      document.getElementById("stats-title").textContent = data.statsSection.title;
      var statsSubtitleEl = document.getElementById("stats-subtitle");
      statsSubtitleEl.textContent = data.statsSection.subtitle;
      statsSubtitleEl.dataset.baseSubtitle = data.statsSection.subtitle || "";

      const statsGrid = document.getElementById("stats-grid");
      statsGrid.innerHTML = "";

      data.statsSection.cards.forEach(function (card) {
// Inside statsSection.cards.forEach
const cardLabel = card.label || "";
const isFndcAlerts = cardLabel === "FNDC Alerts";
const isEmergencyNews = cardLabel === "Emergency News Stories";
const isWaterOutages = cardLabel === "Water Outages";
const isPowerOutages = cardLabel === "Power Outages";
const isNztaRoadClosures = cardLabel === "Road Closures NZTA";
const isLocalRoadClosures = cardLabel === "Road Closures Local";
const isWeatherWarnings = cardLabel === "Weather Warnings";
const isCivilDefenceWarnings = cardLabel === "Civil Defence Warnings";

const tagName =
  isFndcAlerts || isEmergencyNews || isWaterOutages || isPowerOutages || isNztaRoadClosures || isLocalRoadClosures || isWeatherWarnings || isCivilDefenceWarnings ? "button" : "a";
        const cardEl = document.createElement(tagName);

        cardEl.className =
          "stat-card" + (card.colorClass ? " " + card.colorClass : "");

        // Mark the card so helper functions can find it
        cardEl.setAttribute("data-stat-label", cardLabel);

        if (tagName === "a") {
          cardEl.href = card.url || "#";
          if (card.external) {
            cardEl.target = "_blank";
            cardEl.rel = "noopener";
          }
        } else {
          cardEl.type = "button";
        }

        if (card.ariaLabel) {
          cardEl.setAttribute("aria-label", card.ariaLabel);
        }

        const numberDiv = document.createElement("div");
        numberDiv.className = "stat-number";
        numberDiv.textContent = card.number;

        const infoDiv = document.createElement("div");
        infoDiv.className = "stat-info";

        const titleDiv = document.createElement("div");
        titleDiv.className = "stat-title";
        titleDiv.textContent = cardLabel;

        var kindLabel = "Alerts";
        var kindClass = "alerts";
        if (isNztaRoadClosures || isLocalRoadClosures) {
          kindLabel = "Roads";
          kindClass = "roads";
        } else if (isWaterOutages || isPowerOutages) {
          kindLabel = "Utilities";
          kindClass = "utilities";
        }
        const kindDiv = document.createElement("span");
        kindDiv.className = "stat-kind " + kindClass;
        kindDiv.textContent = kindLabel;

        const badge = document.createElement("span");
        badge.className = "stat-badge normal";
        badge.setAttribute("data-stat-badge", "true");
        badge.textContent = "normal";

        const descP = document.createElement("p");
        descP.className = "stat-desc";
        descP.textContent = card.description || "Tap view details for full information.";
        descP.setAttribute("data-base-desc", card.description || "");

        const metaDiv = document.createElement("div");
        metaDiv.className = "stat-meta";
        const pillRow = document.createElement("div");
        pillRow.className = "stat-pill-row";
        pillRow.appendChild(kindDiv);
        if (tagName === "button") {
          pillRow.appendChild(badge);
        }
        const actionSpan = document.createElement("span");
        actionSpan.className = "stat-action";
        actionSpan.textContent = tagName === "button" ? "View details" : "Open link";

        metaDiv.appendChild(pillRow);
        metaDiv.appendChild(actionSpan);

        infoDiv.appendChild(titleDiv);
        infoDiv.appendChild(descP);
        infoDiv.appendChild(metaDiv);

        cardEl.appendChild(numberDiv);
        cardEl.appendChild(infoDiv);

        // FNDC Alerts opens alerts modal
        if (isFndcAlerts) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openFndcAlertsModal();
          });
        }

        // Emergency News Stories opens news stories modal
        if (isEmergencyNews) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openEmergencyNewsStoriesModal();
          });
        }
		
		// water outages
        if (isWaterOutages) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openWaterOutagesModal();
          });
        }
        if (isPowerOutages) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openPowerOutagesModal();
          });
        }
        if (isNztaRoadClosures) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openNztaRoadClosuresModal();
          });
        }
        if (isLocalRoadClosures) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openLocalRoadClosuresModal();
          });
        }
        if (isWeatherWarnings) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openWeatherWarningsModal();
          });
        }
        if (isCivilDefenceWarnings) {
          cardEl.addEventListener("click", function (event) {
            event.preventDefault();
            openCivilDefenceWarningsModal();
          });
        }

        statsGrid.appendChild(cardEl);
      });

      // Stats modal helpers and dynamic data
      setupStatsModalEvents();
      applyStatsRuntimeSettings(data.runtimeConfig && data.runtimeConfig.stats ? data.runtimeConfig.stats : {});
      updateStatCardsUpdatedMeta();
      loadConfiguredStatsData();


      // Social feeds section
      if (data.socialFeedsSection) {
        var socialConfig = data.socialFeedsSection;
        var socialTitleEl = document.getElementById("social-title");
        var socialSubtitleEl = document.getElementById("social-subtitle");
        var socialNoteEl = document.getElementById("social-note");
        var socialTabsEl = document.getElementById("social-tabs");
        var socialIframeEl = document.getElementById("social-iframe");

        if (socialTitleEl) {
          socialTitleEl.textContent = socialConfig.title || "";
        }
        if (socialSubtitleEl) {
          socialSubtitleEl.textContent = socialConfig.subtitle || "";
        }
        if (socialNoteEl) {
          socialNoteEl.textContent = socialConfig.note || "";
        }

        if (socialTabsEl && socialIframeEl && Array.isArray(socialConfig.tabs)) {
          socialTabsEl.innerHTML = "";

          socialConfig.tabs.forEach(function (tab, index) {
            var btn = document.createElement("button");
            btn.type = "button";
            btn.className =
              "social-tab" + (index === 0 ? " is-active" : "");
            btn.textContent = tab.label || "Feed";
            btn.setAttribute("role", "tab");
            btn.setAttribute("data-tab-id", tab.id || "");
            btn.setAttribute(
              "aria-selected",
              index === 0 ? "true" : "false"
            );

            btn.addEventListener("click", function () {
              var allTabs = socialTabsEl.querySelectorAll(".social-tab");
              allTabs.forEach(function (t) {
                t.classList.remove("is-active");
                t.setAttribute("aria-selected", "false");
              });

              btn.classList.add("is-active");
              btn.setAttribute("aria-selected", "true");

              if (tab.iframeSrc) {
                socialIframeEl.src = tab.iframeSrc;
                socialIframeEl.title = (tab.label || "Social media") + " feed";
              }
            });

            socialTabsEl.appendChild(btn);

            // Initialise iframe with the first tab
            if (index === 0 && tab.iframeSrc) {
              socialIframeEl.src = tab.iframeSrc;
              socialIframeEl.title =
                (tab.label || "Social media") + " feed";
            }
          });
        }
      }

     


      // Tiles section and groups
      applyTilesRuntimeSettings(data.runtimeConfig && data.runtimeConfig.tiles ? data.runtimeConfig.tiles : {});
      document.getElementById("tiles-title").textContent = data.tilesSection.title;
      document.getElementById("tiles-subtitle").textContent = data.tilesSection.subtitle;

      const tileGroupsContainer = document.getElementById("tile-groups");
      data.tilesSection.groups.forEach(function (group) {
        const groupSection = document.createElement("section");
        groupSection.className = "tile-group";
        groupSection.setAttribute("aria-label", group.title + " level information");

        const headerDiv = document.createElement("div");
        headerDiv.className = "tile-group-header";

        const h4 = document.createElement("h4");
        h4.textContent = group.title;

        const spanDesc = document.createElement("span");
        spanDesc.textContent = group.description;

        headerDiv.appendChild(h4);
        headerDiv.appendChild(spanDesc);

        const gridDiv = document.createElement("div");
        gridDiv.className = "tile-grid";

        group.tiles.forEach(function (tile) {
          const a = document.createElement("a");
          a.className = "tile" + (tile.colorClass ? " " + tile.colorClass : "");
          a.href = tile.url || "#";
          if (tile.external) {
            a.target = "_blank";
            a.rel = "noopener";
          }

          const iconSpan = document.createElement("span");
          iconSpan.className = "icon";
          iconSpan.setAttribute("aria-hidden", "true");
          iconSpan.textContent = tile.icon || "";

          const mainDiv = document.createElement("div");
          mainDiv.className = "tile-main";

          const titleH4 = document.createElement("h4");
          titleH4.textContent = tile.title;
          const descP = document.createElement("p");
          descP.textContent = tile.description;

          mainDiv.appendChild(titleH4);
          mainDiv.appendChild(descP);

          let metaDiv = null;
          if (tile.metaTop || tile.metaBottom) {
            metaDiv = document.createElement("div");
            metaDiv.className = "tile-meta";

            if (tile.metaTop) {
              const strong = document.createElement("strong");
              strong.textContent = tile.metaTop;
              metaDiv.appendChild(strong);
            }

            if (tile.metaBottom) {
              const span = document.createElement("span");
              span.textContent = tile.metaBottom;
              metaDiv.appendChild(span);
            }
          }

          a.appendChild(iconSpan);
          a.appendChild(mainDiv);
          if (metaDiv) {
            a.appendChild(metaDiv);
          }

          gridDiv.appendChild(a);
        });

        groupSection.appendChild(headerDiv);
        groupSection.appendChild(gridDiv);
        tileGroupsContainer.appendChild(groupSection);
      });

      // Quick links
      const quickLinksContainer = document.getElementById("quick-links");
      data.tilesSection.quickLinks.forEach(function (link) {
        const a = document.createElement("a");
        a.className = "link-chip";
        a.href = link.url || "#";
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = link.label;
        quickLinksContainer.appendChild(a);
      });

           /**
       * Fetch and append emergency banner items into the summary panel.
       * Uses the /Apps/emergencybanners feed which is not strict JSON.
       */
           /**
       * Fetch and append emergency banner items into the summary panel.
       * Uses the /Apps/emergencybanners feed which is not strict JSON.
       */
      function loadEmergencyBannersIntoSummary(container) {
        if (!container || !window.fetch) {
          return;
        }
        var farNorthAlertsSinceDays = 14;
        try {
          var summaryRuntime = data && data.runtimeConfig && data.runtimeConfig.summary
            ? data.runtimeConfig.summary
            : {};
          var parsedDays = parseInt(summaryRuntime.farNorthAlertsSinceDays, 10);
          if (!isNaN(parsedDays)) {
            farNorthAlertsSinceDays = Math.max(1, Math.min(120, parsedDays));
          }
        } catch (_summaryRuntimeErr) {
          farNorthAlertsSinceDays = 14;
        }

        fetchTextWithFeedStatus("fndc.emergency_banners.summary", EMERGENCY_BANNERS_URL, { cache: "no-store" })
          .then(function (rawText) {
            var items = parseEmergencyBannerFeed(rawText);
            if (!items || !items.length) {
              return;
            }
            var filteredItems = filterItemsBySinceDays(items, farNorthAlertsSinceDays, ["publishDate", "endDate"]);
            if (!filteredItems.length) {
              container.innerHTML = '<p><small>No current Far North alerts in the last ' + String(farNorthAlertsSinceDays) + ' days.</small></p>';
              return;
            }

            // Remove the first empty placeholder paragraph if it exists
            var firstChild = container.firstElementChild;
            if (firstChild && !firstChild.textContent.trim()) {
              container.removeChild(firstChild);
            }

            // Take the first few items in feed order which is newest first
            var topItems = filteredItems.slice(0, 3);
            topItems.forEach(function (item) {
              var wrapper = document.createElement("div");
              wrapper.className =
                "summary-banner alert-card " + mapBannerCardClass(item.alertType);

              var heading = document.createElement("div");
              heading.className = "summary-banner-heading";

              var badgeSpan = document.createElement("span");
              badgeSpan.className =
                "badge " + mapBannerBadgeClass(item.alertType);
              badgeSpan.textContent = item.alertType
                ? capitaliseFirst(item.alertType)
                : "Alert";

              var titleStrong = document.createElement("strong");
              titleStrong.textContent = item.title || "";

              heading.appendChild(badgeSpan);
              heading.appendChild(document.createTextNode(" "));
              heading.appendChild(titleStrong);

              var body = document.createElement("div");
              body.className = "summary-banner-body";

              if (item.description) {
                body.textContent = stripHtml(item.description);
              }

              wrapper.appendChild(heading);
              wrapper.appendChild(body);

              container.appendChild(wrapper);
            });
            var windowMeta = document.createElement("p");
            windowMeta.className = "alert-list-meta";
            windowMeta.innerHTML = "<small>Far North alerts window: last " + String(farNorthAlertsSinceDays) + " days.</small>";
            container.appendChild(windowMeta);
          })
          .catch(function (error) {
            console.warn("Could not load emergency banners for summary panel", error);
          });
      }

	  
	        function mapBannerCardClass(alertType) {
        var t = (alertType || "").toLowerCase();
        if (t === "warning") {
          return "alert-orange";
        }
        if (t === "info") {
          return "alert-yellow";
        }
        return "alert-default";
      }

      function mapBannerBadgeClass(alertType) {
        var t = (alertType || "").toLowerCase();
        if (t === "warning") {
          return "alert-orange";
        }
        if (t === "info") {
          return "alert-yellow";
        }
        return "alert-default";
      }

      function capitaliseFirst(str) {
        if (!str) return "";
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
      }


            /**
       * Very small parser for the emergency banner feed.
       * The feed looks like:
       * {{ "Title":"..", "Description":"..", "AlertType":"..", "PublishDate":"..", "EndDate":".." },{ ... },}
       * It is not valid JSON so this extracts the key fields with a regular expression.
       */
      function parseEmergencyBannerFeed(rawText) {
        if (!rawText) {
          return [];
        }
        var text = String(rawText).trim();
        if (!text) {
          return [];
        }

        var items = [];
        var pattern = /{\s*"Title":"([^"]+)"([\s\S]*?)"Description":"([^"]*?)"([\s\S]*?)"AlertType":"([^"]+)"([\s\S]*?)"PublishDate":"([^"]+)"([\s\S]*?)"EndDate":"([^"]+)"\s*}/g;
        var match;
        while ((match = pattern.exec(text)) !== null) {
          items.push({
            title: match[1].trim(),
            description: match[3].trim(),
            alertType: match[5].trim(),
            publishDate: match[7].trim(),
            endDate: match[9].trim()
          });
        }
        return items;
      }

// Shared storage for FNDC alerts
let fndcAlertsItems = [];
// Shared storage for FNDC emergency news stories
let emergencyNewsStoriesItems = [];

// Shared storage for water outages used by the Water Outages stat card
let waterOutagesStatItems = [];
let powerOutagesStatItems = [];
let nztaRoadClosuresStatItems = [];
let localRoadClosuresStatItems = [];
let weatherWarningsStatItems = [];
let civilDefenceWarningsStatItems = [];

var statsRefreshTimer = (typeof statsRefreshTimer === "undefined" || statsRefreshTimer === null) ? null : statsRefreshTimer;
var statsLastUpdatedIso = (typeof statsLastUpdatedIso === "undefined" || statsLastUpdatedIso === null) ? "" : statsLastUpdatedIso;
var STATS_RUNTIME_CFG = (typeof STATS_RUNTIME_CFG === "undefined" || STATS_RUNTIME_CFG === null) ? null : STATS_RUNTIME_CFG;
var TILES_RUNTIME_CFG = (typeof TILES_RUNTIME_CFG === "undefined" || TILES_RUNTIME_CFG === null) ? null : TILES_RUNTIME_CFG;
var WATER_OUTAGES_STAT_FILTER = {
  statuses: [],
  types: []
};
var POWER_OUTAGES_STAT_FILTER = {
  statuses: []
};

function getDefaultStatusTargetUrls() {
  return {
    fndcAlerts: "https://www.fndc.govt.nz/",
    emergencyNews: "https://www.fndc.govt.nz/Whats-New/Latest-news",
    waterOutages: "https://www.fndc.govt.nz/services/water/Water-outage-updates",
    powerOutages: "https://outages.topenergy.co.nz/",
    nztaRoadClosures: "https://www.journeys.nzta.govt.nz/journey-planner",
    localRoadClosures: "https://www.fndc.govt.nz/services/transport/closures",
    weatherWarnings: "https://www.metservice.com/warnings/home",
    civilDefenceWarnings: "https://www.civildefence.govt.nz/"
  };
}

function getDefaultStatsRuntimeCfg() {
  return {
    enableLiveCounts: true,
    autoRefreshEnabled: false,
    refreshIntervalMs: 120000,
    showConnectionStatus: true,
    showLastUpdated: true,
      liveCountSources: {
        fndcAlerts: true,
        emergencyNews: true,
        waterOutages: true,
        powerOutages: true,
        nztaRoadClosures: true,
        localRoadClosures: true,
        weatherWarnings: true,
        civilDefenceWarnings: true
      },
      waterOutageStatusFilter: ["Reported"],
      waterOutageTypeFilter: [],
      powerOutageStatusFilter: ["unplanned", "plannedActive", "planned"],
      fndcAlertsSinceDays: 14,
      emergencyNewsSinceDays: 14,
      statusTargetUrls: getDefaultStatusTargetUrls()
  };
}

function parseCsvList(value) {
  return String(value || "")
    .split(",")
    .map(function (part) { return part.trim(); })
    .filter(Boolean);
}

function normaliseStringList(list) {
  if (Array.isArray(list)) {
    return list.map(function (v) { return String(v || "").trim(); }).filter(Boolean);
  }
  return parseCsvList(list);
}

function getDefaultTilesRuntimeCfg() {
  return {
    mobileColumns: 2
  };
}

function applyTilesRuntimeSettings(cfg) {
  var defaults = getDefaultTilesRuntimeCfg();
  var src = (cfg && typeof cfg === "object") ? cfg : {};
  var mobileColumns = parseInt(src.mobileColumns, 10);
  if (isNaN(mobileColumns)) mobileColumns = defaults.mobileColumns;
  mobileColumns = Math.max(1, Math.min(2, mobileColumns));
  TILES_RUNTIME_CFG = {
    mobileColumns: mobileColumns
  };
  window.__FNED_TILES_RUNTIME_CFG = TILES_RUNTIME_CFG;
  document.documentElement.style.setProperty("--tile-mobile-columns", String(mobileColumns));
}

function applyStatsRuntimeSettings(cfg) {
  var defaults = getDefaultStatsRuntimeCfg();
  var src = (cfg && typeof cfg === "object") ? cfg : {};
  var sources = (src.liveCountSources && typeof src.liveCountSources === "object") ? src.liveCountSources : {};
  var sourceTargetUrls = (src.statusTargetUrls && typeof src.statusTargetUrls === "object") ? src.statusTargetUrls : {};
  var defaultTargetUrls = defaults.statusTargetUrls || getDefaultStatusTargetUrls();
  var refreshMs = parseInt(src.refreshIntervalMs, 10);
  var fndcAlertsSinceDays = parseInt(src.fndcAlertsSinceDays, 10);
  var emergencyNewsSinceDays = parseInt(src.emergencyNewsSinceDays, 10);
  if (isNaN(refreshMs)) refreshMs = defaults.refreshIntervalMs;
  if (isNaN(fndcAlertsSinceDays)) fndcAlertsSinceDays = defaults.fndcAlertsSinceDays;
  if (isNaN(emergencyNewsSinceDays)) emergencyNewsSinceDays = defaults.emergencyNewsSinceDays;
  refreshMs = Math.max(15000, Math.min(600000, refreshMs));
  fndcAlertsSinceDays = Math.max(1, Math.min(120, fndcAlertsSinceDays));
  emergencyNewsSinceDays = Math.max(1, Math.min(120, emergencyNewsSinceDays));

  STATS_RUNTIME_CFG = {
    enableLiveCounts: src.enableLiveCounts !== false,
    autoRefreshEnabled: !!src.autoRefreshEnabled,
    refreshIntervalMs: refreshMs,
    showConnectionStatus: src.showConnectionStatus !== false,
    showLastUpdated: src.showLastUpdated !== false,
    liveCountSources: {
      fndcAlerts: sources.fndcAlerts !== false,
      emergencyNews: sources.emergencyNews !== false,
      waterOutages: sources.waterOutages !== false,
      powerOutages: sources.powerOutages !== false,
      nztaRoadClosures: sources.nztaRoadClosures !== false,
      localRoadClosures: sources.localRoadClosures !== false,
      weatherWarnings: sources.weatherWarnings !== false,
      civilDefenceWarnings: sources.civilDefenceWarnings !== false
    },
    waterOutageStatusFilter: normaliseStringList(src.waterOutageStatusFilter || defaults.waterOutageStatusFilter),
    waterOutageTypeFilter: normaliseStringList(src.waterOutageTypeFilter || defaults.waterOutageTypeFilter),
    powerOutageStatusFilter: normaliseStringList(src.powerOutageStatusFilter || defaults.powerOutageStatusFilter),
    fndcAlertsSinceDays: fndcAlertsSinceDays,
    emergencyNewsSinceDays: emergencyNewsSinceDays,
    statusTargetUrls: {
      fndcAlerts: String(sourceTargetUrls.fndcAlerts || defaultTargetUrls.fndcAlerts || "").trim(),
      emergencyNews: String(sourceTargetUrls.emergencyNews || defaultTargetUrls.emergencyNews || "").trim(),
      waterOutages: String(sourceTargetUrls.waterOutages || defaultTargetUrls.waterOutages || "").trim(),
      powerOutages: String(sourceTargetUrls.powerOutages || defaultTargetUrls.powerOutages || "").trim(),
      nztaRoadClosures: String(sourceTargetUrls.nztaRoadClosures || defaultTargetUrls.nztaRoadClosures || "").trim(),
      localRoadClosures: String(sourceTargetUrls.localRoadClosures || defaultTargetUrls.localRoadClosures || "").trim(),
      weatherWarnings: String(sourceTargetUrls.weatherWarnings || defaultTargetUrls.weatherWarnings || "").trim(),
      civilDefenceWarnings: String(sourceTargetUrls.civilDefenceWarnings || defaultTargetUrls.civilDefenceWarnings || "").trim()
    }
  };
  window.__FNED_STATS_RUNTIME_CFG = STATS_RUNTIME_CFG;
}

function getStatusTargetUrl(key) {
  var defaults = getDefaultStatusTargetUrls();
  var runtime = (STATS_RUNTIME_CFG && STATS_RUNTIME_CFG.statusTargetUrls && typeof STATS_RUNTIME_CFG.statusTargetUrls === "object")
    ? STATS_RUNTIME_CFG.statusTargetUrls
    : {};
  return String(runtime[key] || defaults[key] || "").trim();
}

function buildStatusSourceFooter(sourceText, targetKey, linkLabel) {
  var text = String(sourceText || "").trim();
  var url = getStatusTargetUrl(targetKey);
  if (!url) {
    return '<p class="stats-modal-source">' + escapeHtml(text) + "</p>";
  }
  return '<p class="stats-modal-source">'
    + escapeHtml(text) + " "
    + '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">'
    + escapeHtml(linkLabel || "Open source page")
    + "</a></p>";
}

function getFeedStatusRecord(feedKey) {
  if (!window.FNED_FEED_STATUS_API || typeof window.FNED_FEED_STATUS_API.getSnapshot !== "function") {
    return null;
  }
  var snapshot = window.FNED_FEED_STATUS_API.getSnapshot();
  if (!Array.isArray(snapshot)) return null;
  return snapshot.find(function (item) { return item && item.key === feedKey; }) || null;
}

function updateStatsSubtitleStatus() {
  var subtitleEl = document.getElementById("stats-subtitle");
  if (!subtitleEl) return;
  var base = subtitleEl.dataset.baseSubtitle || subtitleEl.textContent || "";
  if (String(base).toLowerCase().indexOf("numbers are examples") !== -1) {
    base = "Live status overview.";
  }
  if (!STATS_RUNTIME_CFG) {
    subtitleEl.textContent = base;
    return;
  }
  if (!STATS_RUNTIME_CFG.showLastUpdated) {
    subtitleEl.textContent = base;
    return;
  }
  if (!statsLastUpdatedIso) {
    subtitleEl.textContent = base;
    return;
  }
  var stamp = "";
  try {
    stamp = new Date(statsLastUpdatedIso).toLocaleString();
  } catch (_dtErr) {
    stamp = String(statsLastUpdatedIso);
  }
  subtitleEl.textContent = base + " Last updated: " + stamp + ".";
}

function updateStatConnectionStatus(cardLabel, feedKey) {
  var cardEl = document.querySelector('.stat-card[data-stat-label="' + cardLabel.replace(/"/g, '\\"') + '"]');
  if (!cardEl) return;
  var descEl = cardEl.querySelector(".stat-desc");
  var pillRowEl = cardEl.querySelector(".stat-pill-row");
  if (!descEl) return;
  var base = descEl.getAttribute("data-base-desc") || descEl.textContent || "";
  descEl.textContent = base;
  if (pillRowEl) {
    var existingConn = pillRowEl.querySelectorAll(".stat-conn-pill");
    existingConn.forEach(function (node) { node.remove(); });
  }
  if (!STATS_RUNTIME_CFG) return;
  if (!STATS_RUNTIME_CFG.showConnectionStatus) return;

  var sourceEnabled = true;
  if (feedKey === "fndc.emergency_banners.stats") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.fndcAlerts;
  if (feedKey === "fndc.emergency_stories.stats") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.emergencyNews;
  if (feedKey === "fndc.water_outages.stats") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.waterOutages;
  if (feedKey === "map.top_energy.outages") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.powerOutages;
  if (feedKey === "map.nzta.delays") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.nztaRoadClosures;
  if (feedKey === "map.local_road_closures") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.localRoadClosures;
  if (feedKey === "rwas.metservice.atom") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.weatherWarnings;
  if (feedKey === "rwas.civil_defence.atom") sourceEnabled = STATS_RUNTIME_CFG.liveCountSources.civilDefenceWarnings;
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !sourceEnabled) {
    if (pillRowEl) {
      var offSpan = document.createElement("span");
      offSpan.className = "stat-conn-pill disabled";
      offSpan.textContent = "Live off";
      pillRowEl.appendChild(offSpan);
    }
    setStatCardSeverity(cardLabel, "normal", "live off");
    return;
  }

  var record = getFeedStatusRecord(feedKey);
  var status = record && record.status ? String(record.status).toLowerCase() : "loading";
  var label = status === "ok" ? "ok" : (status === "failed" ? "failed" : "loading");
  var friendly = label === "ok" ? "Connected" : (label === "failed" ? "Issue" : "Updating");
  if (pillRowEl) {
    var statusSpan = document.createElement("span");
    statusSpan.className = "stat-conn-pill " + label;
    statusSpan.textContent = friendly;
    pillRowEl.appendChild(statusSpan);
  }
}

function refreshConfiguredStatConnections() {
  updateStatConnectionStatus("FNDC Alerts", "fndc.emergency_banners.stats");
  updateStatConnectionStatus("Emergency News Stories", "fndc.emergency_stories.stats");
  updateStatConnectionStatus("Water Outages", "fndc.water_outages.stats");
  updateStatConnectionStatus("Power Outages", "map.top_energy.outages");
  updateStatConnectionStatus("Road Closures NZTA", "map.nzta.delays");
  updateStatConnectionStatus("Road Closures Local", "map.local_road_closures");
  updateStatConnectionStatus("Weather Warnings", "rwas.metservice.atom");
  updateStatConnectionStatus("Civil Defence Warnings", "rwas.civil_defence.atom");
}

function clearStatsRefreshTimer() {
  if (statsRefreshTimer) {
    clearInterval(statsRefreshTimer);
    statsRefreshTimer = null;
  }
}

function scheduleStatsRefresh() {
  clearStatsRefreshTimer();
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.autoRefreshEnabled) return;
  statsRefreshTimer = setInterval(function () {
    loadConfiguredStatsData();
  }, STATS_RUNTIME_CFG.refreshIntervalMs);
}

/**
 * Config for which water outage statuses and types to display
 * in the stats card and modal table.
 *
 * Leave the arrays empty to show all records from the feed.
 * Populate with values to filter, for example:
 *   statuses: ["Reported", "Current", "Restored"]
 */
function applyWaterOutageFilterFromConfig() {
  if (!WATER_OUTAGES_STAT_FILTER) {
    WATER_OUTAGES_STAT_FILTER = { statuses: [], types: [] };
  }
  WATER_OUTAGES_STAT_FILTER.statuses = (STATS_RUNTIME_CFG.waterOutageStatusFilter || []).slice();
  WATER_OUTAGES_STAT_FILTER.types = (STATS_RUNTIME_CFG.waterOutageTypeFilter || []).slice();
}

function applyPowerOutageFilterFromConfig() {
  if (!POWER_OUTAGES_STAT_FILTER) {
    POWER_OUTAGES_STAT_FILTER = { statuses: [] };
  }
  POWER_OUTAGES_STAT_FILTER.statuses = (STATS_RUNTIME_CFG.powerOutageStatusFilter || []).slice();
}

function normaliseFilterToken(value) {
  return String(value == null ? "" : value)
    .toLowerCase()
    .replace(/[\s_-]+/g, "");
}

function canonicalPowerStatus(value) {
  var token = normaliseFilterToken(value);
  if (!token) return "";
  if (token === "plannedactive" || token === "activeplanned") return "plannedactive";
  if (token === "planned") return "planned";
  if (token === "unplanned") return "unplanned";
  return token;
}

function getObjectValueByKeys(obj, keys) {
  if (!obj || typeof obj !== "object") return "";
  var candidates = [obj];
  if (obj.attributes && typeof obj.attributes === "object") candidates.push(obj.attributes);
  if (obj.properties && typeof obj.properties === "object") candidates.push(obj.properties);
  for (var c = 0; c < candidates.length; c += 1) {
    var src = candidates[c];
    var map = Object.create(null);
    Object.keys(src).forEach(function (k) {
      map[k.toLowerCase()] = src[k];
    });
    for (var i = 0; i < keys.length; i += 1) {
      var key = keys[i];
      if (Object.prototype.hasOwnProperty.call(src, key)) return src[key];
      var lower = key.toLowerCase();
      if (Object.prototype.hasOwnProperty.call(map, lower)) return map[lower];
    }
  }
  return "";
}

function markStatsLastUpdatedNow() {
  statsLastUpdatedIso = new Date().toISOString();
  updateStatsSubtitleStatus();
  updateStatCardsUpdatedMeta();
}

function updateStatCardsUpdatedMeta() {
  var stamp = "live";
  if (statsLastUpdatedIso) {
    try {
      stamp = "updated " + new Date(statsLastUpdatedIso).toLocaleTimeString();
    } catch (_stampErr) {
      stamp = "updated";
    }
  }
  document.querySelectorAll(".stat-card .stat-updated").forEach(function (el) {
    el.textContent = stamp;
  });
}

function setStatCardSeverity(cardLabel, severity, labelText) {
  var cardEl = document.querySelector('.stat-card[data-stat-label="' + cardLabel.replace(/"/g, '\\"') + '"]');
  if (!cardEl) return;
  var badgeEl = cardEl.querySelector("[data-stat-badge]");
  if (!badgeEl) return;
  var sev = (severity === "critical" || severity === "warning") ? severity : "normal";
  badgeEl.className = "stat-badge " + sev;
  badgeEl.textContent = labelText || sev;
}

function parseDateToTimeMs(value) {
  if (!value) return NaN;
  var ts = Date.parse(String(value));
  return isNaN(ts) ? NaN : ts;
}

function filterItemsBySinceDays(items, sinceDays, candidateFields) {
  if (!Array.isArray(items)) return [];
  var days = parseInt(sinceDays, 10);
  if (isNaN(days) || days <= 0) return items.slice();
  var cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
  var fields = Array.isArray(candidateFields) ? candidateFields : [];
  return items.filter(function (item) {
    if (!item || typeof item !== "object") return false;
    var foundParseableDate = false;
    for (var i = 0; i < fields.length; i += 1) {
      var raw = item[fields[i]];
      var ts = parseDateToTimeMs(raw);
      if (!isNaN(ts)) {
        foundParseableDate = true;
        return ts >= cutoff;
      }
    }
    return !foundParseableDate;
  });
}

function ensureWarningCardNotation(cardLabel) {
  var cardEl = document.querySelector('.stat-card[data-stat-label="' + cardLabel.replace(/"/g, '\\"') + '"]');
  if (!cardEl) return;
  var descEl = cardEl.querySelector(".stat-desc");
  if (!descEl) return;
  if (descEl.getAttribute("data-rwas-notation") === "1") return;
  var base = descEl.getAttribute("data-base-desc") || descEl.textContent || "";
  var withNotation = base;
  if (withNotation.indexOf("Current Warnings And Alerts panel") === -1) {
    withNotation = (base ? base : "Live warning count.") + " Source: Current Warnings And Alerts panel (RWAS).";
  }
  descEl.setAttribute("data-base-desc", withNotation);
  descEl.textContent = withNotation;
  descEl.setAttribute("data-rwas-notation", "1");
}

function updateExternalWarningStatCard(cardLabel, count, singularAria, pluralAria) {
  var cardEl = document.querySelector('.stat-card[data-stat-label="' + cardLabel.replace(/"/g, '\\"') + '"]');
  if (!cardEl) return;
  var safeCount = Math.max(0, parseInt(count, 10) || 0);
  var numberEl = cardEl.querySelector(".stat-number");
  if (numberEl) {
    numberEl.textContent = String(safeCount);
  }
  var aria = safeCount === 1 ? singularAria : (safeCount + " " + pluralAria);
  cardEl.setAttribute("aria-label", aria);
  ensureWarningCardNotation(cardLabel);
}

function syncWarningCardsFromRwasSummary() {
  var summary = window.FNED_RWAS_ALERT_SUMMARY;
  if (!summary || typeof summary !== "object") return;
  weatherWarningsStatItems = Array.isArray(summary.weatherItems) ? summary.weatherItems.slice() : [];
  civilDefenceWarningsStatItems = Array.isArray(summary.civilDefenceItems) ? summary.civilDefenceItems.slice() : [];
  updateExternalWarningStatCard(
    "Weather Warnings",
    parseInt(summary.weatherCount, 10) || 0,
    "1 weather warning. View MetService weather warnings.",
    "weather warnings. View MetService weather warnings."
  );
  updateExternalWarningStatCard(
    "Civil Defence Warnings",
    parseInt(summary.civilDefenceCount, 10) || 0,
    "1 civil defence warning. View national civil defence information.",
    "civil defence warnings. View national civil defence information."
  );
}

function loadWeatherWarningsStat() {
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.weatherWarnings) {
    refreshConfiguredStatConnections();
    return;
  }
  syncWarningCardsFromRwasSummary();
  refreshConfiguredStatConnections();
}

function loadCivilDefenceWarningsStat() {
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.civilDefenceWarnings) {
    refreshConfiguredStatConnections();
    return;
  }
  syncWarningCardsFromRwasSummary();
  refreshConfiguredStatConnections();
}

function loadConfiguredStatsData() {
  applyWaterOutageFilterFromConfig();
  applyPowerOutageFilterFromConfig();
  refreshConfiguredStatConnections();
  if (!STATS_RUNTIME_CFG.enableLiveCounts) {
    updateStatsSubtitleStatus();
    scheduleStatsRefresh();
    return;
  }
  if (STATS_RUNTIME_CFG.liveCountSources.fndcAlerts) {
    loadFndcAlertsStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.emergencyNews) {
    loadEmergencyNewsStoriesStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.waterOutages) {
    loadWaterOutagesStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.powerOutages) {
    loadPowerOutagesStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.nztaRoadClosures) {
    loadNztaRoadClosuresStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.localRoadClosures) {
    loadLocalRoadClosuresStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.weatherWarnings) {
    loadWeatherWarningsStat();
  }
  if (STATS_RUNTIME_CFG.liveCountSources.civilDefenceWarnings) {
    loadCivilDefenceWarningsStat();
  }
  updateStatsSubtitleStatus();
  scheduleStatsRefresh();
}



/**
 * Load FNDC alerts from the emergency banners feed
 * and update the FNDC Alerts stat card.
 */
function loadFndcAlertsStat() {
  if (!window.fetch || typeof parseEmergencyBannerFeed !== "function") {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.fndcAlerts) {
    refreshConfiguredStatConnections();
    return;
  }

  fetchTextWithFeedStatus("fndc.emergency_banners.stats", EMERGENCY_BANNERS_URL, { cache: "no-store" })
    .then(function (rawText) {
      const items = parseEmergencyBannerFeed(rawText) || [];
      const filtered = filterItemsBySinceDays(items, STATS_RUNTIME_CFG.fndcAlertsSinceDays, ["publishDate", "endDate"]);
      fndcAlertsItems = filtered;
      updateFndcAlertsStatFromItems(filtered);
      markStatsLastUpdatedNow();
      refreshConfiguredStatConnections();
    })
    .catch(function (error) {
      console.warn("Could not load FNDC alerts for stats", error);
      refreshConfiguredStatConnections();
    });
}

/**
 * Update the FNDC Alerts stat card count and aria label.
 */
function updateFndcAlertsStatFromItems(items) {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid) {
    return;
  }

  const cardEl = statsGrid.querySelector('[data-stat-label="FNDC Alerts"]');
  if (!cardEl) {
    return;
  }

  const count = Array.isArray(items) ? items.length : 0;

  const numberEl = cardEl.querySelector(".stat-number");
  if (numberEl) {
    numberEl.textContent = String(count);
  }

  const aria =
    count === 1
      ? "1 FNDC alert. View Far North District Council alerts."
      : count + " FNDC alerts. View Far North District Council alerts.";

  cardEl.setAttribute("aria-label", aria);
  setStatCardSeverity("FNDC Alerts", count > 5 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

/**
 * Parse the emergency stories feed from /Apps/emergencystories
 * The payload is not standard JSON so we use a regex pattern
 * similar to the emergency banners parser.
 */
function parseEmergencyStoriesFeed(rawText) {
  if (!rawText) {
    return [];
  }

  const text = String(rawText).trim();
  if (!text) {
    return [];
  }

  const items = [];
  const pattern = /{\s*"Title":"([^"]+)"([\s\S]*?)"Description":"([^"]*?)"([\s\S]*?)"PublishDate":"([^"]+)"([\s\S]*?)"URL":"([^"]+)"([\s\S]*?)"ImageURL":"([^"]+)"\s*}/g;

  let match;
  while ((match = pattern.exec(text)) !== null) {
    items.push({
      title: match[1].trim(),
      description: match[3].trim(),
      publishDate: match[5].trim(),
      url: match[7].trim(),
      imageUrl: match[9].trim()
    });
  }

  return items;
}

/**
 * Fetch emergency news stories and update the
 * "Emergency News Stories" stat card with the count.
 */
function loadEmergencyNewsStoriesStat() {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid || !window.fetch) {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.emergencyNews) {
    refreshConfiguredStatConnections();
    return;
  }

  fetchTextWithFeedStatus("fndc.emergency_stories.stats", EMERGENCY_STORIES_URL, { cache: "no-store" })
    .then(function (rawText) {
      const items = parseEmergencyStoriesFeed(rawText) || [];
      const filtered = filterItemsBySinceDays(items, STATS_RUNTIME_CFG.emergencyNewsSinceDays, ["publishDate"]);
      emergencyNewsStoriesItems = filtered;
      updateEmergencyNewsStoriesStatFromItems(filtered);
      markStatsLastUpdatedNow();
      refreshConfiguredStatConnections();
    })
    .catch(function (error) {
      console.warn("Could not load emergency news stories for stats", error);
      refreshConfiguredStatConnections();
    });
}

/**
 * Given already parsed items update the stat card
 * that has label "Emergency News Stories".
 */
function updateEmergencyNewsStoriesStatFromItems(items) {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid) {
    return;
  }

  const cardEl = statsGrid.querySelector(
    '[data-stat-label="Emergency News Stories"]'
  );

  if (!cardEl) {
    return;
  }

  const count = Array.isArray(items) ? items.length : 0;
  const numberEl = cardEl.querySelector(".stat-number");

  if (numberEl) {
    numberEl.textContent = String(count);
  }

  const aria =
    count === 1
      ? "1 emergency news story. View emergency news stories from Far North District Council."
      : count +
        " emergency news stories. View emergency news stories from Far North District Council.";

  cardEl.setAttribute("aria-label", aria);
  setStatCardSeverity("Emergency News Stories", count > 3 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

/**
 * Helper to test if a water outage record matches the configured filters.
 * Status filter is based on WATER_OUTAGES_STAT_FILTER.statuses.
 * Type filter is reserved for future use and will currently do nothing
 * unless the feed adds a type field.
 */
function waterOutageMatchesStatFilter(item) {
  if (!item) {
    return false;
  }

  var status = String(getObjectValueByKeys(item, [
    "status",
    "outageStatus",
    "waterStatus",
    "state"
  ]) || "").trim();
  var type = String(getObjectValueByKeys(item, [
    "type",
    "outageType",
    "category",
    "kind"
  ]) || "").trim();

  var runtimeStatuses = STATS_RUNTIME_CFG && Array.isArray(STATS_RUNTIME_CFG.waterOutageStatusFilter)
    ? STATS_RUNTIME_CFG.waterOutageStatusFilter
    : [];
  var runtimeTypes = STATS_RUNTIME_CFG && Array.isArray(STATS_RUNTIME_CFG.waterOutageTypeFilter)
    ? STATS_RUNTIME_CFG.waterOutageTypeFilter
    : [];
  var statusesFilter = runtimeStatuses.length
    ? runtimeStatuses
    : ((WATER_OUTAGES_STAT_FILTER && Array.isArray(WATER_OUTAGES_STAT_FILTER.statuses)) ? WATER_OUTAGES_STAT_FILTER.statuses : []);
  var typesFilter = runtimeTypes.length
    ? runtimeTypes
    : ((WATER_OUTAGES_STAT_FILTER && Array.isArray(WATER_OUTAGES_STAT_FILTER.types)) ? WATER_OUTAGES_STAT_FILTER.types : []);
  var statusToken = normaliseFilterToken(status);
  var typeToken = normaliseFilterToken(type);
  var statusFilterTokens = statusesFilter.map(normaliseFilterToken).filter(Boolean);
  var typeFilterTokens = typesFilter.map(normaliseFilterToken).filter(Boolean);

  var statusOk =
    !statusFilterTokens.length ||
    statusFilterTokens.indexOf(statusToken) !== -1;

  var typeOk =
    !typeFilterTokens.length ||
    typeFilterTokens.indexOf(typeToken) !== -1;

  return statusOk && typeOk;
}
/**
 * Parsing helper for the water outage feed text used by the stats block.
 * The feed can have trailing commas, be missing array brackets, or have
 * extra wrapper characters. This tries several strategies:
 *  1. Direct JSON.parse
 *  2. Wrap in [ ] and fix ",]" patterns
 *  3. As a last resort, extract each { "name": ... } block and build an array
 */
function parseWaterOutagesStatFeed(rawText) {
  if (!rawText) {
    return [];
  }

  var text = String(rawText).trim();
  if (!text) {
    return [];
  }

  var parsed = null;

  // 1) Try direct JSON
  try {
    parsed = JSON.parse(text);
  } catch (errDirect) {
    // ignore, we will try other approaches
  }

  // 2) Try wrapping with [ ] and fixing trailing ",]"
  if (!parsed) {
    var fixed = text;

    if (!fixed.startsWith("[")) {
      fixed = "[" + fixed;
    }
    if (!fixed.endsWith("]")) {
      fixed = fixed + "]";
    }

    // Turn "..., ]" into "...]"
    fixed = fixed.replace(/,\s*]/g, "]");

    try {
      parsed = JSON.parse(fixed);
    } catch (secondError) {
      // 3) Last resort: extract each outage object by "name" field
      // This ignores any outer wrapper braces you may have added
      var objectMatches = text.match(/{\s*"name"\s*:[\s\S]*?}/gi);

      if (!objectMatches || !objectMatches.length) {
        console.warn(
          "Could not parse water outages feed for stats",
          secondError
        );
        return [];
      }

      var joined = "[" + objectMatches.join(",") + "]";
      try {
        parsed = JSON.parse(joined);
      } catch (thirdError) {
        console.warn(
          "Could not parse water outages feed for stats after object extraction",
          thirdError
        );
        return [];
      }
    }
  }

  // Normalise output to an array
  if (Array.isArray(parsed)) {
    return parsed;
  }

  // If you ever change the feed to be { "items": [ ... ] }
  if (parsed && Array.isArray(parsed.items)) {
    return parsed.items;
  }

  console.warn("Water outages stats feed did not return an array", parsed);
  return [];
}


/**
 * Load water outages for the stats card and modal.
 * Uses the existing WATER_OUTAGES_URL constant from the map layer.
 */
function loadWaterOutagesStat() {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Water Outages"]'
  );
  if (!cardEl) {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.waterOutages) {
    refreshConfiguredStatConnections();
    return;
  }

  fetchTextWithFeedStatus("fndc.water_outages.stats", WATER_OUTAGES_URL, { cache: "no-store" })
    .then(function (text) {
      var rawItems = parseWaterOutagesStatFeed(text);
      waterOutagesStatItems = rawItems.filter(waterOutageMatchesStatFilter);
      updateWaterOutagesStatFromItems(waterOutagesStatItems);
      markStatsLastUpdatedNow();
      refreshConfiguredStatConnections();
    })
    .catch(function (error) {
      console.warn("Failed to load water outages stats", error);
      refreshConfiguredStatConnections();
    });
}

/**
 * Update the Water Outages stat card count and aria label
 * based on the currently filtered items.
 */
function updateWaterOutagesStatFromItems(items) {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Water Outages"]'
  );
  if (!cardEl) {
    return;
  }

  var count = items && items.length ? items.length : 0;
  var numberEl = cardEl.querySelector(".stat-number");

  if (numberEl) {
    numberEl.textContent = String(count);
  }

  // Accessible label for screen readers
  var ariaLabel = "Water outages " + count;
  cardEl.setAttribute("aria-label", ariaLabel);
  setStatCardSeverity("Water Outages", count > 20 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

function powerOutageStatusLabel(statusType) {
  if (statusType === "unplanned") return "Unplanned";
  if (statusType === "plannedActive") return "Planned Active";
  if (statusType === "planned") return "Planned";
  return String(statusType || "Unknown");
}

function nztaRoadEventTypeLabel(typeKey) {
  var key = String(typeKey || "").toLowerCase();
  if (key === "closures") return "Closure";
  if (key === "warnings") return "Warning";
  if (key === "roadworks") return "Roadworks";
  if (key === "hazards") return "Hazard";
  return key ? key.charAt(0).toUpperCase() + key.slice(1) : "Road event";
}

function firstPointFromGeoFeature(feature) {
  if (!feature || !feature.geometry) {
    return { lat: null, lng: null };
  }
  var g = feature.geometry;
  if (g.type === "Point" && Array.isArray(g.coordinates) && g.coordinates.length >= 2) {
    return { lng: g.coordinates[0], lat: g.coordinates[1] };
  }
  if (g.type === "MultiLineString" && Array.isArray(g.coordinates) && g.coordinates.length) {
    var firstLine = g.coordinates[0];
    if (Array.isArray(firstLine) && firstLine.length && Array.isArray(firstLine[0]) && firstLine[0].length >= 2) {
      return { lng: firstLine[0][0], lat: firstLine[0][1] };
    }
  }
  return { lat: null, lng: null };
}

function normaliseNztaRoadEventsFromMapPayload(payload) {
  var sourceItems = [];
  if (payload && Array.isArray(payload.items)) {
    sourceItems = payload.items;
  } else if (payload && Array.isArray(payload.features)) {
    sourceItems = payload.features.map(function (feature, index) {
      var p = feature && feature.properties ? feature.properties : {};
      var point = firstPointFromGeoFeature(feature);
      return {
        id: String(p.Id != null ? p.Id : (p.EventId != null ? p.EventId : index + 1)),
        title: String(p.Name || p.LocationArea || "Road event"),
        eventType: String(p.EventType || p.type || ""),
        impact: String(p.Impact || ""),
        description: String(p.EventDescription || ""),
        comments: String(p.EventComments || ""),
        startDateNice: String(p.StartDateNice || ""),
        endDateNice: String(p.EndDateNice || ""),
        expectedResolution: String(p.ExpectedResolution || ""),
        alternativeRoute: String(p.AlternativeRoute || ""),
        locationArea: String(p.LocationArea || ""),
        typeKey: String(p.type || "").toLowerCase(),
        lat: point.lat,
        lng: point.lng,
        feature: feature
      };
    });
  }
  return sourceItems.map(function (item) {
    var feature = item && item.feature ? item.feature : null;
    var p = feature && feature.properties ? feature.properties : {};
    var point = firstPointFromGeoFeature(feature);
    return {
      id: item && item.id != null ? String(item.id) : String(p.Id != null ? p.Id : ""),
      title: item && item.title ? String(item.title) : String(p.Name || p.LocationArea || "Road event"),
      eventType: item && item.eventType ? String(item.eventType) : String(p.EventType || p.type || ""),
      impact: item && item.impact ? String(item.impact) : String(p.Impact || ""),
      description: item && item.description ? String(item.description) : String(p.EventDescription || ""),
      comments: item && item.comments ? String(item.comments) : String(p.EventComments || ""),
      startDateNice: item && item.startDateNice ? String(item.startDateNice) : String(p.StartDateNice || ""),
      endDateNice: item && item.endDateNice ? String(item.endDateNice) : String(p.EndDateNice || ""),
      expectedResolution: item && item.expectedResolution ? String(item.expectedResolution) : String(p.ExpectedResolution || ""),
      alternativeRoute: item && item.alternativeRoute ? String(item.alternativeRoute) : String(p.AlternativeRoute || ""),
      locationArea: item && item.locationArea ? String(item.locationArea) : String(p.LocationArea || ""),
      typeKey: String((item && item.typeKey) || p.type || "").toLowerCase(),
      lat: item && item.lat != null ? item.lat : point.lat,
      lng: item && item.lng != null ? item.lng : point.lng,
      feature: feature
    };
  });
}

function nztaRoadEventMatchesAlertScope(item) {
  var api = window.FNED_ALERT_SCOPE_API;
  if (!api || typeof api.featureMatchesAreaScope !== "function") {
    return true;
  }
  return !!api.featureMatchesAreaScope(item && item.feature ? item.feature : null);
}

function applyNztaScopeAndSort(items) {
  var scoped = (Array.isArray(items) ? items : []).filter(nztaRoadEventMatchesAlertScope);
  return scoped.sort(function (a, b) {
    var aType = String(a && a.typeKey || "");
    var bType = String(b && b.typeKey || "");
    if (aType === bType) {
      return String(a && a.title || "").localeCompare(String(b && b.title || ""));
    }
    return aType.localeCompare(bType);
  });
}

function updateNztaRoadClosuresStatFromItems(items) {
  var cardEl = document.querySelector('.stat-card[data-stat-label="Road Closures NZTA"]');
  if (!cardEl) {
    return;
  }
  var count = Array.isArray(items) ? items.length : 0;
  var numberEl = cardEl.querySelector(".stat-number");
  if (numberEl) {
    numberEl.textContent = String(count);
  }
  var actionEl = cardEl.querySelector(".stat-action");
  var scopeApi = window.FNED_ALERT_SCOPE_API;
  var scopedActive = !!(scopeApi && scopeApi.isScopedAreaFilteringActive);
  if (actionEl) {
    actionEl.textContent = scopedActive ? "Scoped by alerts areas" : "View details";
  }
  cardEl.setAttribute("aria-label", "NZTA road closures and warnings " + count);
  setStatCardSeverity("Road Closures NZTA", count > 20 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

function setNztaRoadClosuresFromMapPayload(payload) {
  var allItems = normaliseNztaRoadEventsFromMapPayload(payload);
  nztaRoadClosuresStatItems = applyNztaScopeAndSort(allItems);
  updateNztaRoadClosuresStatFromItems(nztaRoadClosuresStatItems);
  markStatsLastUpdatedNow();
  refreshConfiguredStatConnections();
}

function loadNztaRoadClosuresStat() {
  var cardEl = document.querySelector('.stat-card[data-stat-label="Road Closures NZTA"]');
  if (!cardEl) {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.nztaRoadClosures) {
    refreshConfiguredStatConnections();
    return;
  }
  var cached = window.__FNED_MAP_NZTA_ROAD_EVENTS_DATA;
  if (cached && Array.isArray(cached.items)) {
    setNztaRoadClosuresFromMapPayload(cached);
    return;
  }
  fetchJsonWithFeedStatus("map.nzta.delays", NZTA_DELAYS_STATUS_URL, { cache: "no-store" })
    .then(function (payload) {
      setNztaRoadClosuresFromMapPayload(payload);
    })
    .catch(function (error) {
      console.warn("Failed to load NZTA delays for status", error);
      refreshConfiguredStatConnections();
    });
}

function openNztaRoadClosuresModal() {
  var backdrop = document.getElementById("stats-modal-backdrop");
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");
  if (!backdrop || !modalTitle || !modalBody) {
    return;
  }
  modalTitle.textContent = "NZTA road closures and warnings";

  var counts = { closures: 0, warnings: 0, roadworks: 0, hazards: 0, other: 0 };
  var rowsHtml = "";
  nztaRoadClosuresStatItems.forEach(function (item) {
    var k = String(item && item.typeKey || "").toLowerCase();
    if (Object.prototype.hasOwnProperty.call(counts, k)) {
      counts[k] += 1;
    } else {
      counts.other += 1;
    }
    rowsHtml +=
      "<tr>" +
      "<td>" + escapeHtml(item.title || "") + "</td>" +
      "<td>" + escapeHtml(item.locationArea || "") + "</td>" +
      "<td>" + renderStatsTablePill(nztaRoadEventTypeLabel(item.typeKey), "info") + "</td>" +
      "<td>" + escapeHtml(item.impact || "") + "</td>" +
      "<td>" + escapeHtml(item.startDateNice || "") + "</td>" +
      "<td>" + escapeHtml(item.endDateNice || "") + "</td>" +
      '<td class="stats-cell-details">' + escapeHtml((item.alternativeRoute || item.expectedResolution || item.comments || item.description || "")) + "</td>" +
      "</tr>";
  });
  if (!rowsHtml) {
    rowsHtml = '<tr><td colspan="7" class="stats-modal-no-data">No NZTA events match the current alerts area scope.</td></tr>';
  }
  var scopeApi = window.FNED_ALERT_SCOPE_API || {};
  var scopeActive = !!scopeApi.isScopedAreaFilteringActive;
  var scopeAreas = []
    .concat(Array.isArray(scopeApi.loadedCustomAreaNames) ? scopeApi.loadedCustomAreaNames : [])
    .concat(Array.isArray(scopeApi.loadedLinzAreaNames) ? scopeApi.loadedLinzAreaNames : []);
  var scopeLabel = scopeActive
    ? (scopeAreas.length ? scopeAreas.join(", ") : "custom alert areas")
    : (scopeApi.showNonFarNorthAlerts ? "all configured NZTA events" : "Far North scope");
  var summaryHtml =
    '<div class="stats-modal-summary">' +
    "<span>Total: " + escapeHtml(String(nztaRoadClosuresStatItems.length || 0)) + "</span>" +
    "<span>Closures: " + escapeHtml(String(counts.closures || 0)) + "</span>" +
    "<span>Warnings: " + escapeHtml(String(counts.warnings || 0)) + "</span>" +
    "<span>Roadworks: " + escapeHtml(String(counts.roadworks || 0)) + "</span>" +
    "<span>Hazards: " + escapeHtml(String(counts.hazards || 0)) + "</span>" +
    "<span>Scope: " + escapeHtml(scopeLabel) + "</span>" +
    "</div>";

  modalBody.innerHTML =
    summaryHtml +
    '<table class="stats-modal-table">' +
    "<thead><tr>" +
    "<th>Location</th>" +
    "<th>Area</th>" +
    "<th>Type</th>" +
    "<th>Impact</th>" +
    "<th>From</th>" +
    "<th>Until</th>" +
    "<th>Details</th>" +
    "</tr></thead>" +
    "<tbody>" + rowsHtml + "</tbody>" +
    "</table>" +
    buildStatusSourceFooter("NZTA delays feed, scoped by Alerts area settings.", "nztaRoadClosures", "Open NZTA travel planner");
  showStatsModal();
}

function powerOutageMatchesStatFilter(item) {
  if (!item) return false;
  var runtimeStatuses = STATS_RUNTIME_CFG && Array.isArray(STATS_RUNTIME_CFG.powerOutageStatusFilter)
    ? STATS_RUNTIME_CFG.powerOutageStatusFilter
    : [];
  var statuses = runtimeStatuses.length
    ? runtimeStatuses
    : ((POWER_OUTAGES_STAT_FILTER && Array.isArray(POWER_OUTAGES_STAT_FILTER.statuses)) ? POWER_OUTAGES_STAT_FILTER.statuses : []);
  var statusType = canonicalPowerStatus(item.statusType || "");
  if (!statuses.length) return true;
  var filterStatuses = statuses.map(canonicalPowerStatus).filter(Boolean);
  return filterStatuses.indexOf(statusType) !== -1;
}

function normalisePowerOutagesFromMapPayload(payload) {
  if (!payload || !Array.isArray(payload.items)) {
    return [];
  }
  return payload.items.map(function (item) {
    var detail = item && item.detail ? item.detail : {};
    return {
      id: item && item.id != null ? String(item.id) : "",
      statusType: item && item.statusType ? String(item.statusType) : "",
      lat: item && item.lat != null ? item.lat : "",
      lng: item && item.lng != null ? item.lng : "",
      circuitName: detail.circuitName || "",
      customersCurrentlyOff: detail.customersCurrentlyOff != null ? String(detail.customersCurrentlyOff) : "",
      startDateTime: detail.startDateTime || "",
      endDateTime: detail.endDateTime || "",
      additionalInformation: stripHtml(detail.additionalInformation || "")
    };
  });
}

function updatePowerOutagesStatFromItems(items) {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Power Outages"]'
  );
  if (!cardEl) {
    return;
  }
  var count = items && items.length ? items.length : 0;
  var numberEl = cardEl.querySelector(".stat-number");
  if (numberEl) {
    numberEl.textContent = String(count);
  }
  cardEl.setAttribute("aria-label", "Power outages " + count);
  setStatCardSeverity("Power Outages", count > 10 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

function setPowerOutagesFromMapPayload(payload) {
  var allItems = normalisePowerOutagesFromMapPayload(payload);
  powerOutagesStatItems = allItems.filter(powerOutageMatchesStatFilter);
  updatePowerOutagesStatFromItems(powerOutagesStatItems);
  markStatsLastUpdatedNow();
  refreshConfiguredStatConnections();
}

function loadPowerOutagesStatFallback() {
  Promise.all([
    fetchJsonWithFeedStatus("map.top_energy.regions", TOP_ENERGY_REGIONS_URL, { cache: "no-store" }),
    fetchJsonWithFeedStatus("map.top_energy.outages", TOP_ENERGY_OUTAGES_URL, { cache: "no-store" })
  ]).then(function (results) {
    var regionsData = results[0] || {};
    var outagesData = results[1] || {};
    var regionDetailsById = {};
    Object.keys(regionsData).forEach(function (key) {
      var arr = regionsData[key];
      if (!Array.isArray(arr)) return;
      arr.forEach(function (r) {
        if (r && r.name) regionDetailsById[r.name] = r;
      });
    });

    var items = [];
    function pushList(list, statusType) {
      if (!Array.isArray(list)) return;
      list.forEach(function (outage) {
        if (!outage || outage.id == null || outage.lat == null || outage.lng == null) return;
        items.push({
          id: String(outage.id),
          statusType: String(statusType || ""),
          lat: outage.lat,
          lng: outage.lng,
          detail: regionDetailsById[outage.id] || null
        });
      });
    }
    pushList(outagesData.unplanned, "unplanned");
    pushList(outagesData.plannedActive, "plannedActive");
    pushList(outagesData.planned, "planned");
    setPowerOutagesFromMapPayload({ items: items });
  }).catch(function (error) {
    console.warn("Failed to load power outages stats", error);
    refreshConfiguredStatConnections();
  });
}

function loadPowerOutagesStat() {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Power Outages"]'
  );
  if (!cardEl) {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.powerOutages) {
    refreshConfiguredStatConnections();
    return;
  }
  var cached = window.__FNED_MAP_POWER_OUTAGES_DATA;
  if (cached && Array.isArray(cached.items)) {
    setPowerOutagesFromMapPayload(cached);
    return;
  }
  loadPowerOutagesStatFallback();
}

function openPowerOutagesModal() {
  var backdrop = document.getElementById("stats-modal-backdrop");
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");

  if (!backdrop || !modalTitle || !modalBody) {
    return;
  }

  modalTitle.textContent = "Power outages";

  var rowsHtml = "";
  var statusCounts = { unplanned: 0, plannedActive: 0, planned: 0 };
  if (powerOutagesStatItems && powerOutagesStatItems.length) {
    powerOutagesStatItems.forEach(function (item) {
      if (!powerOutageMatchesStatFilter(item)) return;
      if (statusCounts[item.statusType] != null) {
        statusCounts[item.statusType] += 1;
      }
      rowsHtml +=
        "<tr>" +
        "<td>" + escapeHtml(item.id || "") + "</td>" +
        "<td>" + renderStatsTablePill(powerOutageStatusLabel(item.statusType), (item.statusType === "unplanned" ? "danger" : "warning")) + "</td>" +
        "<td>" + escapeHtml(item.circuitName || "") + "</td>" +
        "<td>" + escapeHtml(item.customersCurrentlyOff || "") + "</td>" +
        "<td>" + escapeHtml(item.startDateTime || "") + "</td>" +
        "<td>" + escapeHtml(item.endDateTime || "") + "</td>" +
        '<td class="stats-cell-details">' + escapeHtml(item.additionalInformation || "") + "</td>" +
        "</tr>";
    });
  }
  if (!rowsHtml) {
    rowsHtml = '<tr><td colspan="7" class="stats-modal-no-data">No power outages match the current status filter.</td></tr>';
  }

  var summaryHtml =
    '<div class="stats-modal-summary">' +
    "<span>Total: " + escapeHtml(String(powerOutagesStatItems.length || 0)) + "</span>" +
    "<span>Unplanned: " + escapeHtml(String(statusCounts.unplanned || 0)) + "</span>" +
    "<span>Planned Active: " + escapeHtml(String(statusCounts.plannedActive || 0)) + "</span>" +
    "<span>Planned: " + escapeHtml(String(statusCounts.planned || 0)) + "</span>" +
    "</div>";

  modalBody.innerHTML =
    summaryHtml +
    '<table class="stats-modal-table">' +
    "<thead><tr>" +
    "<th>Outage ID</th>" +
    "<th>Status</th>" +
    "<th>Circuit</th>" +
    "<th>Customers Off</th>" +
    "<th>From</th>" +
    "<th>Until</th>" +
    "<th>Details</th>" +
    "</tr></thead>" +
    "<tbody>" + rowsHtml + "</tbody>" +
    "</table>" +
    buildStatusSourceFooter("Top Energy outage data from map feed.", "powerOutages", "Open Top Energy outages");
  showStatsModal();
}

function normaliseLocalRoadClosuresFromPayload(payload) {
  if (!payload || !Array.isArray(payload.items)) {
    return [];
  }
  return payload.items.map(function (item) {
    return {
      road_id: item && item.road_id ? String(item.road_id) : "",
      road_status: item && item.road_status ? String(item.road_status) : "",
      type: item && item.type ? String(item.type) : "",
      cause: item && item.cause ? String(item.cause) : "",
      detour: !!(item && item.detour),
      detour_details: item && item.detour_details ? String(item.detour_details) : "",
      s_datetime: item && item.s_datetime ? String(item.s_datetime) : "",
      e_datetime: item && item.e_datetime ? String(item.e_datetime) : "",
      c_description: item && item.c_description ? String(item.c_description) : "",
      info_updated: item && item.info_updated ? String(item.info_updated) : "",
      event_name: item && item.event_name ? String(item.event_name) : ""
    };
  });
}

function extractLocalRoadClosuresRows(payload) {
  if (Array.isArray(payload)) {
    return payload;
  }
  if (payload && Array.isArray(payload.data)) {
    return payload.data;
  }
  if (payload && Array.isArray(payload.items)) {
    return payload.items;
  }
  if (payload && Array.isArray(payload.rows)) {
    return payload.rows;
  }
  return [];
}

function tryParseGitHubRawUrl(url) {
  var value = String(url || "").trim();
  var re = /^https?:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/i;
  var match = value.match(re);
  if (!match) {
    return null;
  }
  return {
    owner: match[1],
    repo: match[2],
    ref: match[3],
    path: match[4]
  };
}

function normaliseGitHubRawSourceUrl(url) {
  var value = String(url || "").trim();
  return value.replace("/refs/heads/", "/");
}

function buildLocalRoadClosuresStatusCandidates() {
  var candidates = [];
  function add(url) {
    var value = String(url || "").trim();
    if (!value) return;
    if (candidates.indexOf(value) === -1) {
      candidates.push(value);
    }
  }
  add(LOCAL_ROAD_CLOSURES_STATUS_URL);
  add(LOCAL_ROAD_CLOSURES_STATUS_SOURCE_URL);
  add(normaliseGitHubRawSourceUrl(LOCAL_ROAD_CLOSURES_STATUS_SOURCE_URL));
  var parsed = tryParseGitHubRawUrl(normaliseGitHubRawSourceUrl(LOCAL_ROAD_CLOSURES_STATUS_SOURCE_URL));
  if (parsed) {
    add("https://raw.githubusercontent.com/" + parsed.owner + "/" + parsed.repo + "/" + parsed.ref + "/" + parsed.path);
    add("https://api.github.com/repos/" + parsed.owner + "/" + parsed.repo + "/contents/" + parsed.path + "?ref=" + encodeURIComponent(parsed.ref));
  }
  return candidates;
}

function decodeGitHubContentsPayload(payload) {
  if (!payload || payload.encoding !== "base64" || !payload.content) {
    return null;
  }
  try {
    var decoded = atob(String(payload.content).replace(/\s+/g, ""));
    return JSON.parse(decoded);
  } catch (_err) {
    return null;
  }
}

function fetchLocalRoadClosuresStatusPayload(candidates, idx) {
  if (!Array.isArray(candidates) || idx >= candidates.length) {
    return Promise.reject(new Error("No local road closures status source succeeded"));
  }
  var url = candidates[idx];
  return fetchJsonWithFeedStatus("map.local_road_closures", url, { cache: "no-store" })
    .then(function (payload) {
      var rows = extractLocalRoadClosuresRows(payload);
      if (rows.length) {
        return { rows: rows };
      }
      var decoded = decodeGitHubContentsPayload(payload);
      rows = extractLocalRoadClosuresRows(decoded);
      if (rows.length) {
        return { rows: rows };
      }
      return fetchLocalRoadClosuresStatusPayload(candidates, idx + 1);
    })
    .catch(function () {
      return fetchLocalRoadClosuresStatusPayload(candidates, idx + 1);
    });
}

function updateLocalRoadClosuresStatFromItems(items) {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Road Closures Local"]'
  );
  if (!cardEl) {
    return;
  }
  var count = Array.isArray(items) ? items.length : 0;
  var numberEl = cardEl.querySelector(".stat-number");
  if (numberEl) {
    numberEl.textContent = String(count);
  }
  cardEl.setAttribute("aria-label", "Local road closures " + count);
  setStatCardSeverity("Road Closures Local", count > 3 ? "critical" : (count > 0 ? "warning" : "normal"), count > 0 ? "active" : "normal");
}

function setLocalRoadClosuresStatFromItems(items) {
  localRoadClosuresStatItems = Array.isArray(items) ? items.slice() : [];
  updateLocalRoadClosuresStatFromItems(localRoadClosuresStatItems);
  markStatsLastUpdatedNow();
  refreshConfiguredStatConnections();
}

function loadLocalRoadClosuresStat() {
  var cardEl = document.querySelector(
    '.stat-card[data-stat-label="Road Closures Local"]'
  );
  if (!cardEl) {
    return;
  }
  if (!STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.localRoadClosures) {
    refreshConfiguredStatConnections();
    return;
  }
  var cached = window.__FNED_MAP_LOCAL_ROAD_CLOSURES_DATA;
  if (cached && Array.isArray(cached.items)) {
    setLocalRoadClosuresStatFromItems(normaliseLocalRoadClosuresFromPayload(cached));
    return;
  }
  var localSnapshotRows = extractLocalRoadClosuresRows(window.__FNED_PUBLIC_CLOSURES_SNAPSHOT);
  if (String(window.location && window.location.protocol || "").toLowerCase() === "file:" && localSnapshotRows.length) {
    setLocalRoadClosuresStatFromItems(normaliseLocalRoadClosuresFromPayload({ items: localSnapshotRows }));
    return;
  }
  fetchLocalRoadClosuresStatusPayload(buildLocalRoadClosuresStatusCandidates(), 0)
    .then(function (result) {
      var rows = result && Array.isArray(result.rows) ? result.rows : [];
      setLocalRoadClosuresStatFromItems(normaliseLocalRoadClosuresFromPayload({ items: rows }));
    })
    .catch(function (error) {
      var fallbackRows = extractLocalRoadClosuresRows(window.__FNED_PUBLIC_CLOSURES_SNAPSHOT);
      if (fallbackRows.length) {
        setLocalRoadClosuresStatFromItems(normaliseLocalRoadClosuresFromPayload({ items: fallbackRows }));
      } else {
        console.warn("Failed to load local road closures stats", error);
        refreshConfiguredStatConnections();
      }
    });
}

function openLocalRoadClosuresModal() {
  var backdrop = document.getElementById("stats-modal-backdrop");
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");
  if (!backdrop || !modalTitle || !modalBody) {
    return;
  }
  modalTitle.textContent = "Local road closures";

  var rowsHtml = "";
  if (localRoadClosuresStatItems && localRoadClosuresStatItems.length) {
    localRoadClosuresStatItems.forEach(function (item) {
      rowsHtml +=
        "<tr>" +
        "<td>" + escapeHtml(item.road_id || "") + "</td>" +
        "<td>" + renderStatsTablePill(item.road_status || "", "warning") + "</td>" +
        "<td>" + renderStatsTablePill(item.type || "", "neutral") + "</td>" +
        "<td>" + escapeHtml(item.cause || "") + "</td>" +
        "<td>" + escapeHtml(item.s_datetime || "") + "</td>" +
        "<td>" + escapeHtml(item.e_datetime || "") + "</td>" +
        "<td>" + (item.detour ? "Yes" : "No") + "</td>" +
        "</tr>";
    });
  }
  if (!rowsHtml) {
    rowsHtml = '<tr><td colspan="7" class="stats-modal-no-data">No local road closures in current feed.</td></tr>';
  }

  modalBody.innerHTML =
    '<table class="stats-modal-table">' +
    "<thead><tr>" +
    "<th>Road</th>" +
    "<th>Status</th>" +
    "<th>Type</th>" +
    "<th>Cause</th>" +
    "<th>From</th>" +
    "<th>Until</th>" +
    "<th>Detour</th>" +
    "</tr></thead>" +
    "<tbody>" + rowsHtml + "</tbody>" +
    "</table>" +
    buildStatusSourceFooter("FNDC RAMM public closures feed.", "localRoadClosures", "Open FNDC transport closures");
  showStatsModal();
}

/**
 * Open the stats modal and show a table of all water outages
 * that match the configured filters.
 *
 * Columns:
 * - Name
 * - Status
 * - Address
 * - Date lodged
 * - Date resolved
 * - Details
 * - Description
 */
function openWaterOutagesModal() {
  var backdrop = document.getElementById("stats-modal-backdrop");
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");

  if (!backdrop || !modalTitle || !modalBody) {
    return;
  }

  modalTitle.textContent = "Water outages";

  var rowsHtml = "";

  if (waterOutagesStatItems && waterOutagesStatItems.length) {
    waterOutagesStatItems.forEach(function (item) {
      if (!waterOutageMatchesStatFilter(item)) {
        return;
      }

      var name = escapeHtml(stripHtml(item.name || ""));
      var status = escapeHtml(stripHtml(String(getObjectValueByKeys(item, [
        "status",
        "outageStatus",
        "waterStatus",
        "state"
      ]) || "")));
      var address = escapeHtml(stripHtml(item.address || ""));
      var lodged = escapeHtml(stripHtml(item.datelodged || ""));
      var resolved = escapeHtml(stripHtml(item.dateresolved || ""));

      var detailsText = stripHtml(item.details || "");
      var descriptionText = stripHtml(item.description || "");

      detailsText = escapeHtml(detailsText);
      descriptionText = escapeHtml(descriptionText);

      rowsHtml +=
        "<tr>" +
        "<td>" + name + "</td>" +
        "<td>" + renderStatsTablePill(status, "info") + "</td>" +
        "<td>" + address + "</td>" +
        "<td>" + lodged + "</td>" +
        "<td>" + resolved + "</td>" +
        '<td class="stats-cell-details">' + detailsText + "</td>" +
        '<td class="stats-cell-details">' + descriptionText + "</td>" +
        "</tr>";
    });
  }

  if (!rowsHtml) {
    rowsHtml =
      '<tr><td colspan="7" class="stats-modal-no-data">No water outages match the current filters.</td></tr>';
  }

  var tableHtml =
    '<table class="stats-modal-table">' +
    "<thead>" +
    "<tr>" +
    "<th>Name</th>" +
    "<th>Status</th>" +
    "<th>Address</th>" +
    "<th>Date lodged</th>" +
    "<th>Date resolved</th>" +
    "<th>Details</th>" +
    "<th>Description</th>" +
    "</tr>" +
    "</thead>" +
    "<tbody>" +
    rowsHtml +
    "</tbody>" +
    "</table>";

  var sourceHtml = buildStatusSourceFooter(
    "FNDC water outages from map feed.",
    "waterOutages",
    "Open FNDC water outage updates"
  );

  modalBody.innerHTML = tableHtml + sourceHtml;
  showStatsModal();
}


function escapeHtml(str) {
  if (str == null) {
    return "";
  }
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function renderStatsTablePill(label, tone) {
  var text = String(label || "").trim();
  if (!text) return "";
  var t = String(tone || "neutral").trim().toLowerCase();
  if (!t) t = "neutral";
  return '<span class="stats-table-pill ' + escapeHtml(t) + '">' + escapeHtml(text) + "</span>";
}

function decodeHtmlEntities(value) {
  if (value == null) return "";
  var txt = document.createElement("textarea");
  txt.innerHTML = String(value);
  return txt.value;
}

function normaliseHtmlish(value) {
  var out = String(value == null ? "" : value).trim();
  if (!out) return "";
  if ((out.charAt(0) === '"' && out.charAt(out.length - 1) === '"') ||
      (out.charAt(0) === "'" && out.charAt(out.length - 1) === "'")) {
    out = out.slice(1, -1).trim();
  }
  for (var i = 0; i < 3; i += 1) {
    var decoded = decodeHtmlEntities(out);
    if (decoded === out) break;
    out = decoded;
  }
  return out;
}

function stripHtml(html) {
  var normal = normaliseHtmlish(html);
  if (!normal) return "";
  var withBreaks = normal
    .replace(/<\s*br\s*\/?>/gi, "\n")
    .replace(/<\s*\/p\s*>/gi, "\n")
    .replace(/<\s*\/li\s*>/gi, "\n")
    .replace(/<\s*\/div\s*>/gi, "\n")
    .replace(/<\s*\/tr\s*>/gi, "\n");
  var tempDiv = document.createElement("div");
  tempDiv.innerHTML = withBreaks;
  return String(tempDiv.textContent || tempDiv.innerText || "")
    .replace(/\u00a0/g, " ")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n[ \t]+/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/[ \t]{2,}/g, " ")
    .replace(/\\+["']+$/, "")
    .replace(/^["']+/, "")
    .replace(/["']+$/, "")
    .trim();
}


/**
 * Basic modal show and hide helpers.
 */
function showStatsModal() {
  const backdrop = document.getElementById("stats-modal-backdrop");
  if (!backdrop) {
    return;
  }
  applyResponsiveLabelsToStatsTables(document.getElementById("stats-modal-body"));
  backdrop.classList.add("is-visible");
  backdrop.setAttribute("aria-hidden", "false");
}

function hideStatsModal() {
  const backdrop = document.getElementById("stats-modal-backdrop");
  if (!backdrop) {
    return;
  }
  backdrop.classList.remove("is-visible");
  backdrop.setAttribute("aria-hidden", "true");
}

function applyResponsiveLabelsToStatsTables(container) {
  if (!container) {
    return;
  }
  var tables = container.querySelectorAll(".stats-modal-table");
  tables.forEach(function (table) {
    var headers = Array.prototype.map.call(table.querySelectorAll("thead th"), function (th) {
      return String(th.textContent || "").trim();
    });
    Array.prototype.forEach.call(table.querySelectorAll("tbody tr"), function (row) {
      var cells = row.querySelectorAll("td");
      Array.prototype.forEach.call(cells, function (cell, idx) {
        if (cell.classList.contains("stats-modal-no-data")) {
          cell.removeAttribute("data-label");
          return;
        }
        var label = headers[idx] || "Value";
        cell.setAttribute("data-label", label);
      });
    });
  });
}

/**
 * One time setup for modal close behaviour.
 */
function setupStatsModalEvents() {
  const backdrop = document.getElementById("stats-modal-backdrop");
  const closeButton = document.getElementById("stats-modal-close");

  if (!backdrop) {
    return;
  }

  // Click on the dimmed area closes the modal
  backdrop.addEventListener("click", function (event) {
    if (event.target === backdrop) {
      hideStatsModal();
    }
  });

  if (closeButton) {
    closeButton.addEventListener("click", function () {
      hideStatsModal();
    });
  }

  // Escape key closes the modal
  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      hideStatsModal();
    }
  });
}

if (!window.__FNED_POWER_OUTAGES_STATS_LISTENER_ATTACHED && typeof window.addEventListener === "function") {
  window.addEventListener("fned:map-power-outages-updated", function (event) {
    if (!STATS_RUNTIME_CFG || !STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.powerOutages) {
      return;
    }
    if (!event || !event.detail) {
      return;
    }
    setPowerOutagesFromMapPayload(event.detail);
  });
  window.__FNED_POWER_OUTAGES_STATS_LISTENER_ATTACHED = true;
}

if (!window.__FNED_NZTA_ROAD_EVENTS_STATS_LISTENER_ATTACHED && typeof window.addEventListener === "function") {
  window.addEventListener("fned:map-nzta-road-events-updated", function (event) {
    if (!STATS_RUNTIME_CFG || !STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.nztaRoadClosures) {
      return;
    }
    if (!event || !event.detail) {
      return;
    }
    setNztaRoadClosuresFromMapPayload(event.detail);
  });
  window.__FNED_NZTA_ROAD_EVENTS_STATS_LISTENER_ATTACHED = true;
}

if (!window.__FNED_LOCAL_ROAD_CLOSURES_STATS_LISTENER_ATTACHED && typeof window.addEventListener === "function") {
  window.addEventListener("fned:map-local-road-closures-updated", function (event) {
    if (!STATS_RUNTIME_CFG || !STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.localRoadClosures) {
      return;
    }
    if (!event || !event.detail) {
      return;
    }
    setLocalRoadClosuresStatFromItems(normaliseLocalRoadClosuresFromPayload(event.detail));
  });
  window.__FNED_LOCAL_ROAD_CLOSURES_STATS_LISTENER_ATTACHED = true;
}

if (!window.__FNED_RWAS_SCOPE_STATUS_LISTENER_ATTACHED && typeof window.addEventListener === "function") {
  window.addEventListener("fned:rwas-runtime-updated", function () {
    if (!STATS_RUNTIME_CFG || !STATS_RUNTIME_CFG.enableLiveCounts || !STATS_RUNTIME_CFG.liveCountSources.nztaRoadClosures) {
      return;
    }
    loadNztaRoadClosuresStat();
  });
  window.__FNED_RWAS_SCOPE_STATUS_LISTENER_ATTACHED = true;
}

if (!window.__FNED_RWAS_ALERTS_STATUS_LISTENER_ATTACHED && typeof window.addEventListener === "function") {
  window.addEventListener("fned:rwas-alerts-updated", function () {
    syncWarningCardsFromRwasSummary();
    refreshConfiguredStatConnections();
  });
  window.__FNED_RWAS_ALERTS_STATUS_LISTENER_ATTACHED = true;
}

function warningStatusLabel(status) {
  var token = String(status || "").toLowerCase();
  if (token === "active-now") return "Active now";
  if (token === "upcoming") return "Upcoming";
  if (token === "expired") return "Expired";
  return token || "Unknown";
}

function openWeatherWarningsModal() {
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");
  if (!modalBody || !modalTitle) return;
  modalTitle.textContent = "Weather Warnings";
  var items = Array.isArray(weatherWarningsStatItems) ? weatherWarningsStatItems : [];
  var rowsHtml = items.map(function (item) {
    var areas = Array.isArray(item.areas) ? item.areas.join(", ") : "";
    var details = stripHtml(item.html || "");
    return (
      "<tr>" +
      "<td>MetService</td>" +
      "<td>" + renderStatsTablePill(warningStatusLabel(item.status), item.status === "active-now" ? "danger" : "warning") + "</td>" +
      "<td>" + escapeHtml(areas) + "</td>" +
      '<td class="stats-cell-details">' + escapeHtml(details) + "</td>" +
      "</tr>"
    );
  }).join("");
  if (!rowsHtml) {
    rowsHtml = '<tr><td colspan="4" class="stats-modal-no-data">No weather warnings in the current alerts window.</td></tr>';
  }
  modalBody.innerHTML =
    '<table class="stats-modal-table">' +
    "<thead><tr><th>Source</th><th>Status</th><th>Areas</th><th>Details</th></tr></thead>" +
    "<tbody>" + rowsHtml + "</tbody></table>" +
    buildStatusSourceFooter("Source: Current Warnings And Alerts panel (RWAS / MetService).", "weatherWarnings", "Open MetService warnings");
  showStatsModal();
}

function openCivilDefenceWarningsModal() {
  var modalTitle = document.getElementById("stats-modal-title");
  var modalBody = document.getElementById("stats-modal-body");
  if (!modalBody || !modalTitle) return;
  modalTitle.textContent = "Civil Defence Warnings";
  var items = Array.isArray(civilDefenceWarningsStatItems) ? civilDefenceWarningsStatItems : [];
  var rowsHtml = items.map(function (item) {
    var areas = Array.isArray(item.areas) ? item.areas.join(", ") : "";
    var details = stripHtml(item.html || "");
    return (
      "<tr>" +
      "<td>Civil Defence</td>" +
      "<td>" + renderStatsTablePill(warningStatusLabel(item.status), item.status === "active-now" ? "danger" : "warning") + "</td>" +
      "<td>" + escapeHtml(areas) + "</td>" +
      '<td class="stats-cell-details">' + escapeHtml(details) + "</td>" +
      "</tr>"
    );
  }).join("");
  if (!rowsHtml) {
    rowsHtml = '<tr><td colspan="4" class="stats-modal-no-data">No civil defence warnings in the current alerts window.</td></tr>';
  }
  modalBody.innerHTML =
    '<table class="stats-modal-table">' +
    "<thead><tr><th>Source</th><th>Status</th><th>Areas</th><th>Details</th></tr></thead>" +
    "<tbody>" + rowsHtml + "</tbody></table>" +
    buildStatusSourceFooter("Source: Current Warnings And Alerts panel (RWAS / Civil Defence).", "civilDefenceWarnings", "Open Civil Defence updates");
  showStatsModal();
}

/**
 * Build and show the FNDC Alerts modal using the
 * items already loaded for the stat card.
 */
function openFndcAlertsModal() {
  const modalTitle = document.getElementById("stats-modal-title");
  const modalBody = document.getElementById("stats-modal-body");

  if (!modalBody || !modalTitle) {
    return;
  }

  modalTitle.textContent = "FNDC Alerts";

  const items = Array.isArray(fndcAlertsItems) ? fndcAlertsItems : [];

  if (!items.length) {
    var fndcSinceDays = STATS_RUNTIME_CFG && STATS_RUNTIME_CFG.fndcAlertsSinceDays ? STATS_RUNTIME_CFG.fndcAlertsSinceDays : 14;
    modalBody.innerHTML =
      "<p>No current Far North District Council alerts in the last " + String(fndcSinceDays) + " days.</p>" +
      buildStatusSourceFooter("Source: FNDC.govt.nz for data and details.", "fndcAlerts", "Open FNDC homepage");
    showStatsModal();
    return;
  }

  // Simple table, you can tweak columns later
  const rowsHtml = items
    .map(function (item) {
      const title = escapeHtml(stripHtml(item.title || ""));
      const type = stripHtml(item.alertType || "");
      const description = escapeHtml(stripHtml(item.description || ""));
      const publish = escapeHtml(stripHtml(item.publishDate || ""));
      const end = escapeHtml(stripHtml(item.endDate || ""));

      return (
        "<tr>" +
        "<td>" + title + "</td>" +
        "<td>" + renderStatsTablePill(type, "warning") + "</td>" +
        '<td class="stats-cell-details">' + description + "</td>" +
        "<td>" + publish + "</td>" +
        "<td>" + end + "</td>" +
        "</tr>"
      );
    })
    .join("");

  modalBody.innerHTML =
    '<p class="stats-modal-source">Window: last ' + String(STATS_RUNTIME_CFG && STATS_RUNTIME_CFG.fndcAlertsSinceDays ? STATS_RUNTIME_CFG.fndcAlertsSinceDays : 14) + " days.</p>" +
    '<table class="stats-modal-table">' +
    "<thead>" +
    "<tr>" +
    "<th>Title</th>" +
    "<th>Type</th>" +
    "<th>Details</th>" +
    "<th>Start</th>" +
    "<th>End</th>" +
    "</tr>" +
    "</thead>" +
    "<tbody>" +
    rowsHtml +
    "</tbody>" +
    "</table>" +
    buildStatusSourceFooter("Source: FNDC.govt.nz for data and details.", "fndcAlerts", "Open FNDC homepage");

  showStatsModal();
}


/**
 * Build and show the Emergency News Stories modal
 * using the items already loaded for the stat card.
 */
function openEmergencyNewsStoriesModal() {
  const modalTitle = document.getElementById("stats-modal-title");
  const modalBody = document.getElementById("stats-modal-body");

  if (!modalBody || !modalTitle) {
    return;
  }

  modalTitle.textContent = "Emergency News Stories";

  const items = Array.isArray(emergencyNewsStoriesItems)
    ? emergencyNewsStoriesItems
    : [];

  if (!items.length) {
    var newsSinceDays = STATS_RUNTIME_CFG && STATS_RUNTIME_CFG.emergencyNewsSinceDays ? STATS_RUNTIME_CFG.emergencyNewsSinceDays : 14;
    modalBody.innerHTML =
      "<p>No current emergency news stories in the last " + String(newsSinceDays) + " days.</p>" +
      buildStatusSourceFooter("FNDC emergency news stories.", "emergencyNews", "Open FNDC latest news");
    showStatsModal();
    return;
  }

  const rowsHtml = items
    .map(function (item) {
      const title = escapeHtml(stripHtml(item.title || ""));
      const description = escapeHtml(stripHtml(item.description || ""));
      const publish = escapeHtml(stripHtml(item.publishDate || ""));
      const url = escapeHtml(String(item.url || "#"));

      return (
        "<tr>" +
        '<td><a href="' +
        url +
        '" target="_blank" rel="noopener">' +
        title +
        "</a></td>" +
        '<td class="stats-cell-details">' +
        description +
        "</td>" +
        "<td>" +
        publish +
        "</td>" +
        "</tr>"
      );
    })
    .join("");

  modalBody.innerHTML =
    '<p class="stats-modal-source">Window: last ' + String(STATS_RUNTIME_CFG && STATS_RUNTIME_CFG.emergencyNewsSinceDays ? STATS_RUNTIME_CFG.emergencyNewsSinceDays : 14) + " days.</p>" +
    '<table class="stats-modal-table">' +
    "<thead>" +
    "<tr>" +
    "<th>Title</th>" +
    "<th>Description</th>" +
    "<th>Published</th>" +
    "</tr>" +
    "</thead>" +
    "<tbody>" +
    rowsHtml +
    "</tbody>" +
    "</table>" +
    buildStatusSourceFooter("FNDC emergency news stories.", "emergencyNews", "Open FNDC latest news");

  showStatsModal();
}


      
function applyLayoutFromConfig(cfg) {
  const layout = (cfg && cfg.layout) ? cfg.layout : {};
  const modules = Array.isArray(layout.modules) ? layout.modules : [];
  const byId = new Map(modules.map(m => [m.id, m]));

  // Show or hide modules
  document.querySelectorAll("[data-module-id]").forEach(function (el) {
    const id = el.getAttribute("data-module-id");
    const mod = byId.get(id);
    if (mod && mod.enabled === false) {
      el.style.display = "none";
    } else {
      el.style.display = "";
    }
  });

  // Show or hide submodules
  const situation = byId.get("situation");
  if (situation && Array.isArray(situation.submodules)) {
    situation.submodules.forEach(function (sub) {
      const subEl = document.querySelector('[data-submodule-id="' + sub.id + '"]');
      if (!subEl) return;
      if (sub && sub.enabled === false) {
        subEl.style.display = "none";
      } else {
        subEl.style.display = "";
      }
    });
  }

  // Reorder main modules in .main-inner
  const mainInner = document.querySelector(".main-inner");
  if (mainInner) {
    const order = modules
      .map(m => m.id)
      .filter(id => ["ctaRow", "situation", "summary", "stats", "tiles", "social"].includes(id));

    order.forEach(function (id) {
      const el = document.querySelector('[data-module-id="' + id + '"]');
      if (el) mainInner.appendChild(el);
    });
  }
}


      // Footer
      document.getElementById("footer-line-1").textContent = data.footer.line1;
      document.getElementById("footer-line-2").textContent = data.footer.line2;

      // Apply layout ordering and visibility
      applyLayoutFromConfig(data);

    })();
  </script>

  
  <!-- Local road closures fallback snapshot -->
  <script src="./public_closures_FNDC_data.js"></script>

  <!-- Extracted: Map feed script -->
  <!-- Local: ./situation_map_feed.js | Remote: replace src with your hosted URL -->
  <script src="./situation_map_feed.js"></script>
  
  

  <!-- Extracted: RWAS region warning and alerts -->
  <!-- Local: ./rwas_region_warning.js | Remote: replace src with your hosted URL -->
  <script src="./rwas_region_warning.js"></script>

  <!-- PWA helper and service worker register -->
  <script src="./fned_pwa.js"></script>

  <!-- Notifications and custom messages -->
  <script src="./fned_notifications.js"></script>

  <!-- Module editor -->
  <script src="./fned_module_editor.js"></script>

</body>
</html>





